<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BMU: /Users/djgood/WFE/firmware/2018_bmu/Src/batteries.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BMU
   &#160;<span id="projectnumber">2018</span>
   </div>
   <div id="projectbrief">Battery Management Unit</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_413f4e031a85da0d68269c6fd2f76e1c.html">Src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#enum-members">Enumerations</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">batteries.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Battery Monitoring, Charging, HV Bus Sense, IMD monitor.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;batteries.h&quot;</code><br />
<code>#include &quot;FreeRTOS.h&quot;</code><br />
<code>#include &quot;cmsis_os.h&quot;</code><br />
<code>#include &quot;task.h&quot;</code><br />
<code>#include &quot;controlStateMachine.h&quot;</code><br />
<code>#include &quot;debug.h&quot;</code><br />
<code>#include &quot;math.h&quot;</code><br />
<code>#include &quot;BMU_can.h&quot;</code><br />
<code>#include &quot;BMU_dtc.h&quot;</code><br />
<code>#include &quot;boardTypes.h&quot;</code><br />
<code>#include &quot;watchdog.h&quot;</code><br />
<code>#include &quot;canReceive.h&quot;</code><br />
<code>#include &quot;chargerControl.h&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:aadfade60a9946687e6a1a4a24b70fb4c"><td class="memItemLeft" align="right" valign="top"><a id="aadfade60a9946687e6a1a4a24b70fb4c"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>ENABLE_IMD</b></td></tr>
<tr class="separator:aadfade60a9946687e6a1a4a24b70fb4c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa31c40ba22e94296395602249e2b25eb"><td class="memItemLeft" align="right" valign="top"><a id="aa31c40ba22e94296395602249e2b25eb"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>ENABLE_HV_MEASURE</b></td></tr>
<tr class="separator:aa31c40ba22e94296395602249e2b25eb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2828019bbccc5743ed8275fc9a4fe1a3"><td class="memItemLeft" align="right" valign="top"><a id="a2828019bbccc5743ed8275fc9a4fe1a3"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>ENABLE_AMS</b></td></tr>
<tr class="separator:a2828019bbccc5743ed8275fc9a4fe1a3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9fea424f5555dcbb0ba5c1e4871e855f"><td class="memItemLeft" align="right" valign="top"><a id="a9fea424f5555dcbb0ba5c1e4871e855f"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>ENABLE_CHARGER</b></td></tr>
<tr class="separator:a9fea424f5555dcbb0ba5c1e4871e855f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8ba2127550d368f846692fdcf3ca095f"><td class="memItemLeft" align="right" valign="top"><a id="a8ba2127550d368f846692fdcf3ca095f"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>ENABLE_BALANCE</b></td></tr>
<tr class="separator:a8ba2127550d368f846692fdcf3ca095f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a62b353ffb0e0f9735e0c6a32712e85b2"><td class="memItemLeft" align="right" valign="top"><a id="a62b353ffb0e0f9735e0c6a32712e85b2"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>BATTERY_TASK_PERIOD_MS</b>&#160;&#160;&#160;100</td></tr>
<tr class="separator:a62b353ffb0e0f9735e0c6a32712e85b2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6d5ce7bfac0354a10a78a45aa0ebaacf"><td class="memItemLeft" align="right" valign="top"><a id="a6d5ce7bfac0354a10a78a45aa0ebaacf"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>BATTERY_CHARGE_TASK_PERIOD_MS</b>&#160;&#160;&#160;2000</td></tr>
<tr class="separator:a6d5ce7bfac0354a10a78a45aa0ebaacf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeb85d8df3b9f6218cb677ccd44760cd4"><td class="memItemLeft" align="right" valign="top"><a id="aeb85d8df3b9f6218cb677ccd44760cd4"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>BATTERY_TASK_ID</b>&#160;&#160;&#160;2</td></tr>
<tr class="separator:aeb85d8df3b9f6218cb677ccd44760cd4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa4b530cc846953d732a4582912f703d2"><td class="memItemLeft" align="right" valign="top"><a id="aa4b530cc846953d732a4582912f703d2"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>LIMIT_OVERVOLTAGE</b>&#160;&#160;&#160;4.2F</td></tr>
<tr class="separator:aa4b530cc846953d732a4582912f703d2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a582698c135482c98c6911f0bdbf8d1ad"><td class="memItemLeft" align="right" valign="top"><a id="a582698c135482c98c6911f0bdbf8d1ad"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>LIMIT_HIGHVOLTAGE</b>&#160;&#160;&#160;4.2F</td></tr>
<tr class="separator:a582698c135482c98c6911f0bdbf8d1ad"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2f9e0b5026ad096458f1bdcc559cfab7"><td class="memItemLeft" align="right" valign="top"><a id="a2f9e0b5026ad096458f1bdcc559cfab7"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>LIMIT_LOWVOLTAGE</b>&#160;&#160;&#160;3.0F</td></tr>
<tr class="separator:a2f9e0b5026ad096458f1bdcc559cfab7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6136cb9cd8ceabce6e9fdda8cb05c3bd"><td class="memItemLeft" align="right" valign="top"><a id="a6136cb9cd8ceabce6e9fdda8cb05c3bd"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>LIMIT_UNDERVOLTAGE</b>&#160;&#160;&#160;3.0F</td></tr>
<tr class="separator:a6136cb9cd8ceabce6e9fdda8cb05c3bd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab4cdc344852b65658b9d24c04473f26d"><td class="memItemLeft" align="right" valign="top"><a id="ab4cdc344852b65658b9d24c04473f26d"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>LIMIT_LOWVOLTAGE_WARNING</b>&#160;&#160;&#160;3.2F</td></tr>
<tr class="separator:ab4cdc344852b65658b9d24c04473f26d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a374bf63b81c93c7d9e76601f46b9f184"><td class="memItemLeft" align="right" valign="top"><a id="a374bf63b81c93c7d9e76601f46b9f184"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>CELL_TIME_TO_FAILURE_ALLOWABLE</b>&#160;&#160;&#160;(6.0)</td></tr>
<tr class="separator:a374bf63b81c93c7d9e76601f46b9f184"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ace79b123d44fbbb7d6b78e0e9fa98930"><td class="memItemLeft" align="right" valign="top"><a id="ace79b123d44fbbb7d6b78e0e9fa98930"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>CELL_DCR</b>&#160;&#160;&#160;(0.01)</td></tr>
<tr class="separator:ace79b123d44fbbb7d6b78e0e9fa98930"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a16227ae24d95ceebf83b650ccdb0dfa4"><td class="memItemLeft" align="right" valign="top"><a id="a16227ae24d95ceebf83b650ccdb0dfa4"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>CELL_HEAT_CAPACITY</b>&#160;&#160;&#160;(1034.2)</td></tr>
<tr class="separator:a16227ae24d95ceebf83b650ccdb0dfa4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8fec377e4c098c8c294afce44c6c69d0"><td class="memItemLeft" align="right" valign="top"><a id="a8fec377e4c098c8c294afce44c6c69d0"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>CELL_MASS</b>&#160;&#160;&#160;(0.496)</td></tr>
<tr class="separator:a8fec377e4c098c8c294afce44c6c69d0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa72653c5b21b8d21a14cdba38e71c6eb"><td class="memItemLeft" align="right" valign="top"><a id="aa72653c5b21b8d21a14cdba38e71c6eb"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>CELL_OVERTEMP</b>&#160;&#160;&#160;(CELL_MAX_TEMP_C)</td></tr>
<tr class="separator:aa72653c5b21b8d21a14cdba38e71c6eb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8531f997baa2780a823499e18bdebec3"><td class="memItemLeft" align="right" valign="top"><a id="a8531f997baa2780a823499e18bdebec3"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>CELL_OVERTEMP_WARNING</b>&#160;&#160;&#160;(CELL_MAX_TEMP_C - 10)</td></tr>
<tr class="separator:a8531f997baa2780a823499e18bdebec3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad5819e811f281911c5854f40cf58960f"><td class="memItemLeft" align="right" valign="top"><a id="ad5819e811f281911c5854f40cf58960f"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#ad5819e811f281911c5854f40cf58960f">BALANCE_START_VOLTAGE</a>&#160;&#160;&#160;(3.5F)</td></tr>
<tr class="memdesc:ad5819e811f281911c5854f40cf58960f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Block balancing below this cell voltage. <br /></td></tr>
<tr class="separator:ad5819e811f281911c5854f40cf58960f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae7647190367a5af57c404c325ede1e56"><td class="memItemLeft" align="right" valign="top"><a id="ae7647190367a5af57c404c325ede1e56"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#ae7647190367a5af57c404c325ede1e56">CELL_RELAXATION_TIME_MS</a>&#160;&#160;&#160;(1000)</td></tr>
<tr class="memdesc:ae7647190367a5af57c404c325ede1e56"><td class="mdescLeft">&#160;</td><td class="mdescRight">Pause balancing for this length when reading cell voltages to get good readings. <br /></td></tr>
<tr class="separator:ae7647190367a5af57c404c325ede1e56"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1c3f97f617827a946894da14b7e6e4d4"><td class="memItemLeft" align="right" valign="top"><a id="a1c3f97f617827a946894da14b7e6e4d4"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a1c3f97f617827a946894da14b7e6e4d4">CHARGE_STOP_SOC</a>&#160;&#160;&#160;(98.0)</td></tr>
<tr class="memdesc:a1c3f97f617827a946894da14b7e6e4d4"><td class="mdescLeft">&#160;</td><td class="mdescRight">SoC to stop charging at (of the cell with lowest SoC) <br /></td></tr>
<tr class="separator:a1c3f97f617827a946894da14b7e6e4d4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3840db84d2eaac3f4fe59941e21ff410"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a3840db84d2eaac3f4fe59941e21ff410">CHARGE_CART_HEARTBEAT_MAX_PERIOD</a>&#160;&#160;&#160;(1000)</td></tr>
<tr class="separator:a3840db84d2eaac3f4fe59941e21ff410"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a68aaf77b085834ea0c03a6ab2e2910f6"><td class="memItemLeft" align="right" valign="top"><a id="a68aaf77b085834ea0c03a6ab2e2910f6"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a68aaf77b085834ea0c03a6ab2e2910f6">CHARGE_DEFAULT_MAX_CURRENT</a>&#160;&#160;&#160;5</td></tr>
<tr class="memdesc:a68aaf77b085834ea0c03a6ab2e2910f6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Default charging current limit (Amps) <br /></td></tr>
<tr class="separator:a68aaf77b085834ea0c03a6ab2e2910f6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaa9233fe54ffd66274a5dd46390b36e5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#aaa9233fe54ffd66274a5dd46390b36e5">BALANCE_RECHECK_PERIOD_MS</a>&#160;&#160;&#160;(3000)</td></tr>
<tr class="separator:aaa9233fe54ffd66274a5dd46390b36e5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4ec6365ec832a79d6e0633c4f49b3b55"><td class="memItemLeft" align="right" valign="top"><a id="a4ec6365ec832a79d6e0633c4f49b3b55"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>NUM_SOC_LOOKUP_VALS</b>&#160;&#160;&#160;101</td></tr>
<tr class="separator:a4ec6365ec832a79d6e0633c4f49b3b55"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:affc1e4ab7cea9fe57082528ac006cc50"><td class="memItemLeft" align="right" valign="top"><a id="affc1e4ab7cea9fe57082528ac006cc50"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>HV_MEASURE_TASK_PERIOD_MS</b>&#160;&#160;&#160;1</td></tr>
<tr class="separator:affc1e4ab7cea9fe57082528ac006cc50"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab4536de5261b4bd382b10d69f857dbe3"><td class="memItemLeft" align="right" valign="top"><a id="ab4536de5261b4bd382b10d69f857dbe3"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>HV_MEASURE_TASK_ID</b>&#160;&#160;&#160;4</td></tr>
<tr class="separator:ab4536de5261b4bd382b10d69f857dbe3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0fc9cbf2e0173158d4cd0536059a272f"><td class="memItemLeft" align="right" valign="top"><a id="a0fc9cbf2e0173158d4cd0536059a272f"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>STATE_BUS_HV_CAN_SEND_PERIOD_MS</b>&#160;&#160;&#160;500</td></tr>
<tr class="separator:a0fc9cbf2e0173158d4cd0536059a272f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a918bb56d5d536252807bb42ab03b3728"><td class="memItemLeft" align="right" valign="top"><a id="a918bb56d5d536252807bb42ab03b3728"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>IMD_TASK_PERIOD_MS</b>&#160;&#160;&#160;1000</td></tr>
<tr class="separator:a918bb56d5d536252807bb42ab03b3728"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5a2f513c66eeae901bf7536957487e74"><td class="memItemLeft" align="right" valign="top"><a id="a5a2f513c66eeae901bf7536957487e74"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>IMD_TASK_ID</b>&#160;&#160;&#160;5</td></tr>
<tr class="separator:a5a2f513c66eeae901bf7536957487e74"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1951643638039378eccc6e0ffef18a22"><td class="memItemLeft" align="right" valign="top"><a id="a1951643638039378eccc6e0ffef18a22"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a1951643638039378eccc6e0ffef18a22">IBUS_FILTER_ALPHA</a>&#160;&#160;&#160;0.24</td></tr>
<tr class="memdesc:a1951643638039378eccc6e0ffef18a22"><td class="mdescLeft">&#160;</td><td class="mdescRight">Filter constant for HV Bus current low pass filter Designed around 1 ms sample period and 50 Hz cuttoff. See the wikipedia page for the calculation: <a href="https://en.wikipedia.org/wiki/Low-pass_filter#Simple_infinite_impulse_response_filter">https://en.wikipedia.org/wiki/Low-pass_filter#Simple_infinite_impulse_response_filter</a>. <br /></td></tr>
<tr class="separator:a1951643638039378eccc6e0ffef18a22"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad4389fd57fbbb4a3c70d7a626285eaa0"><td class="memItemLeft" align="right" valign="top"><a id="ad4389fd57fbbb4a3c70d7a626285eaa0"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#ad4389fd57fbbb4a3c70d7a626285eaa0">MAX_ERROR_COUNT</a>&#160;&#160;&#160;3</td></tr>
<tr class="memdesc:ad4389fd57fbbb4a3c70d7a626285eaa0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Maximum number of errors battery task can encounter before reporting error. <br /></td></tr>
<tr class="separator:ad4389fd57fbbb4a3c70d7a626285eaa0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9b3fe58b53cbf8d5fbc53709ed5a278b"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a9b3fe58b53cbf8d5fbc53709ed5a278b">CELL_VOLTAGE_FILTER_ALPHA</a>&#160;&#160;&#160;0.18</td></tr>
<tr class="separator:a9b3fe58b53cbf8d5fbc53709ed5a278b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab75dbcd7e0a59fc3d1fc3715de87544a"><td class="memItemLeft" align="right" valign="top"><a id="ab75dbcd7e0a59fc3d1fc3715de87544a"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#ab75dbcd7e0a59fc3d1fc3715de87544a">CAN_CELL_SEND_PERIOD_MS</a>&#160;&#160;&#160;40</td></tr>
<tr class="memdesc:ab75dbcd7e0a59fc3d1fc3715de87544a"><td class="mdescLeft">&#160;</td><td class="mdescRight">The period to send cell voltage and temperature CAN messages. <br /></td></tr>
<tr class="separator:ab75dbcd7e0a59fc3d1fc3715de87544a"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:a57d972b2a0b68887bd7afab4c1d2553f"><td class="memItemLeft" align="right" valign="top">typedef enum <a class="el" href="batteries_8c.html#a2f80b01711da374b25803fa818de09b1">ChargeReturn</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a57d972b2a0b68887bd7afab4c1d2553f">ChargeReturn</a></td></tr>
<tr class="separator:a57d972b2a0b68887bd7afab4c1d2553f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="enum-members"></a>
Enumerations</h2></td></tr>
<tr class="memitem:a2f80b01711da374b25803fa818de09b1"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a2f80b01711da374b25803fa818de09b1">ChargeReturn</a> { <a class="el" href="batteries_8c.html#a2f80b01711da374b25803fa818de09b1a0abf13e2a7d6435eb5b31d33abeadad7">CHARGE_DONE</a>
, <a class="el" href="batteries_8c.html#a2f80b01711da374b25803fa818de09b1a3db9c119e634b77566daafdde61b29f1">CHARGE_STOPPED</a>
, <a class="el" href="batteries_8c.html#a2f80b01711da374b25803fa818de09b1ad0605183af862ee76169e8b41c7fd927">CHARGE_ERROR</a>
 }</td></tr>
<tr class="separator:a2f80b01711da374b25803fa818de09b1"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a1300d8fea84c20d3945380460f61f81d"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a1300d8fea84c20d3945380460f61f81d">filterIBus</a> (float IBus)</td></tr>
<tr class="memdesc:a1300d8fea84c20d3945380460f61f81d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Low pass filters the HV Bus current measurement.  <a href="batteries_8c.html#a1300d8fea84c20d3945380460f61f81d">More...</a><br /></td></tr>
<tr class="separator:a1300d8fea84c20d3945380460f61f81d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a951b2aac55838c4b1abd243f38e2ca47"><td class="memItemLeft" align="right" valign="top"><a id="a951b2aac55838c4b1abd243f38e2ca47"></a>
HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a951b2aac55838c4b1abd243f38e2ca47">initBusVoltagesAndCurrentQueues</a> ()</td></tr>
<tr class="memdesc:a951b2aac55838c4b1abd243f38e2ca47"><td class="mdescLeft">&#160;</td><td class="mdescRight">Creates queues for HV Bus measurements Queue overwrite, Queue peek, and queue size of 1 is used to ensure only the most recent data is in the queue and read from the queue. Queues use Amps and Volts for units. <br /></td></tr>
<tr class="separator:a951b2aac55838c4b1abd243f38e2ca47"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a37d4140213dc1708776032fc935e0b39"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a37d4140213dc1708776032fc935e0b39">publishBusVoltagesAndCurrent</a> (float *pIBus, float *pVBus, float *pVBatt)</td></tr>
<tr class="memdesc:a37d4140213dc1708776032fc935e0b39"><td class="mdescLeft">&#160;</td><td class="mdescRight">Publishes the most recent HV Bus measurements to queues for other tasks to read from Queue overwrite, Queue peek, and queue size of 1 is used to ensure only the most recent data is in the queue and read from the queue.  <a href="batteries_8c.html#a37d4140213dc1708776032fc935e0b39">More...</a><br /></td></tr>
<tr class="separator:a37d4140213dc1708776032fc935e0b39"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4d72951e5a03e396bb864b5c45bda0f0"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a4d72951e5a03e396bb864b5c45bda0f0">readBusVoltagesAndCurrents</a> (float *IBus, float *VBus, float *VBatt)</td></tr>
<tr class="memdesc:a4d72951e5a03e396bb864b5c45bda0f0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Measures HV voltages and currents using the HV ADC.  <a href="batteries_8c.html#a4d72951e5a03e396bb864b5c45bda0f0">More...</a><br /></td></tr>
<tr class="separator:a4d72951e5a03e396bb864b5c45bda0f0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0ee7fbdeb8e2e8413b4fc77ba59223d5"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a0ee7fbdeb8e2e8413b4fc77ba59223d5">getIBus</a> (float *IBus)</td></tr>
<tr class="memdesc:a0ee7fbdeb8e2e8413b4fc77ba59223d5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get the most recent bus current reading.  <a href="batteries_8c.html#a0ee7fbdeb8e2e8413b4fc77ba59223d5">More...</a><br /></td></tr>
<tr class="separator:a0ee7fbdeb8e2e8413b4fc77ba59223d5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aff30116cb629c2efdad61c2ccaec0c36"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#aff30116cb629c2efdad61c2ccaec0c36">getVBatt</a> (float *VBatt)</td></tr>
<tr class="memdesc:aff30116cb629c2efdad61c2ccaec0c36"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get the most recent battery voltage reading (from the HV ADC). Note: this is only equal to the battery voltage when both contactors are closed. to get the battery voltage in all times, use <a class="el" href="batteries_8c.html#ab07aef73f633627b5a1a78e40f15961f">getPackVoltage</a>.  <a href="batteries_8c.html#aff30116cb629c2efdad61c2ccaec0c36">More...</a><br /></td></tr>
<tr class="separator:aff30116cb629c2efdad61c2ccaec0c36"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6fbf3bf910348af26a580fc418f89f5e"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a6fbf3bf910348af26a580fc418f89f5e">getVBus</a> (float *VBus)</td></tr>
<tr class="memdesc:a6fbf3bf910348af26a580fc418f89f5e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get the most recent HV Bus voltage reading (from the HV ADC)  <a href="batteries_8c.html#a6fbf3bf910348af26a580fc418f89f5e">More...</a><br /></td></tr>
<tr class="separator:a6fbf3bf910348af26a580fc418f89f5e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6e1bc0d2209bd309c4db0a06009a339a"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a6e1bc0d2209bd309c4db0a06009a339a">cliSetVBatt</a> (float VBatt)</td></tr>
<tr class="memdesc:a6e1bc0d2209bd309c4db0a06009a339a"><td class="mdescLeft">&#160;</td><td class="mdescRight">For nucleo testing, allows setting a dummy value for the VBatt reading.  <a href="batteries_8c.html#a6e1bc0d2209bd309c4db0a06009a339a">More...</a><br /></td></tr>
<tr class="separator:a6e1bc0d2209bd309c4db0a06009a339a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2ab7e555695e672e38894f394a31a3ef"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a2ab7e555695e672e38894f394a31a3ef">cliSetVBus</a> (float VBus)</td></tr>
<tr class="memdesc:a2ab7e555695e672e38894f394a31a3ef"><td class="mdescLeft">&#160;</td><td class="mdescRight">For nucleo testing, allows setting a dummy value for the VBus reading.  <a href="batteries_8c.html#a2ab7e555695e672e38894f394a31a3ef">More...</a><br /></td></tr>
<tr class="separator:a2ab7e555695e672e38894f394a31a3ef"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a19d5fb02c3547746d76a121bf9f10807"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a19d5fb02c3547746d76a121bf9f10807">cliSetIBus</a> (float IBus)</td></tr>
<tr class="memdesc:a19d5fb02c3547746d76a121bf9f10807"><td class="mdescLeft">&#160;</td><td class="mdescRight">For nucleo testing, allows setting a dummy value for the IBus reading.  <a href="batteries_8c.html#a19d5fb02c3547746d76a121bf9f10807">More...</a><br /></td></tr>
<tr class="separator:a19d5fb02c3547746d76a121bf9f10807"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1ef8191389452a8f21cb2d02b20cba29"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a1ef8191389452a8f21cb2d02b20cba29">HVMeasureTask</a> (void *pvParamaters)</td></tr>
<tr class="separator:a1ef8191389452a8f21cb2d02b20cba29"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1f0375c4fc87fa9cfd8fbc1c5fcd33c9"><td class="memItemLeft" align="right" valign="top"><a id="a1f0375c4fc87fa9cfd8fbc1c5fcd33c9"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a1f0375c4fc87fa9cfd8fbc1c5fcd33c9">imdTask</a> (void *pvParamaters)</td></tr>
<tr class="memdesc:a1f0375c4fc87fa9cfd8fbc1c5fcd33c9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Monitors the Insulation Monitoring Device (IMD). Raises error if IMD reports fault. <br /></td></tr>
<tr class="separator:a1f0375c4fc87fa9cfd8fbc1c5fcd33c9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a36a3c81e474331b59839cb2f565c7704"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a36a3c81e474331b59839cb2f565c7704">readCellVoltagesAndTemps</a> ()</td></tr>
<tr class="memdesc:a36a3c81e474331b59839cb2f565c7704"><td class="mdescLeft">&#160;</td><td class="mdescRight">Reads the cell voltages and temperatures from the AMS boards. The battery temperature and cell voltages are stored in the global arrays which are also used for sending them over CAN.  <a href="batteries_8c.html#a36a3c81e474331b59839cb2f565c7704">More...</a><br /></td></tr>
<tr class="separator:a36a3c81e474331b59839cb2f565c7704"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a34364371025450fc6bc3f0d86df0e5ca"><td class="memItemLeft" align="right" valign="top"><a id="a34364371025450fc6bc3f0d86df0e5ca"></a>
HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a34364371025450fc6bc3f0d86df0e5ca">initVoltageAndTempArrays</a> ()</td></tr>
<tr class="memdesc:a34364371025450fc6bc3f0d86df0e5ca"><td class="mdescLeft">&#160;</td><td class="mdescRight">This functions sets all cell voltages and temps to known values. This is necessary for testing on Nucleo so it doesn't immediately error before the user can manually set the Voltages and Temperatures. <br /></td></tr>
<tr class="separator:a34364371025450fc6bc3f0d86df0e5ca"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad7b6a3fe5ae01ef7695d9c36da0f832b"><td class="memItemLeft" align="right" valign="top"><a id="ad7b6a3fe5ae01ef7695d9c36da0f832b"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#ad7b6a3fe5ae01ef7695d9c36da0f832b">BatteryTaskError</a> ()</td></tr>
<tr class="memdesc:ad7b6a3fe5ae01ef7695d9c36da0f832b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Called if an error with batteries is detected. Raises error and stops battery task execution (without tripping watchdog) <br /></td></tr>
<tr class="separator:ad7b6a3fe5ae01ef7695d9c36da0f832b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a796b02ffebbe6ba22dca62df11bcb05c"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a796b02ffebbe6ba22dca62df11bcb05c">boundedContinue</a> ()</td></tr>
<tr class="memdesc:a796b02ffebbe6ba22dca62df11bcb05c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Called by battery task it an error is encountered that is not immediately fatal. This causes the task to retry its readings/whatever else failed MAX_ERROR_COUNT times, then fail and send error event. TODO: ensure this is max 500 ms to meet rules for cell reading times.  <a href="batteries_8c.html#a796b02ffebbe6ba22dca62df11bcb05c">More...</a><br /></td></tr>
<tr class="separator:a796b02ffebbe6ba22dca62df11bcb05c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd3cd9ec15fdceb68c5516f59552605c"><td class="memItemLeft" align="right" valign="top"><a id="acd3cd9ec15fdceb68c5516f59552605c"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#acd3cd9ec15fdceb68c5516f59552605c">ERROR_COUNTER_SUCCESS</a> ()</td></tr>
<tr class="memdesc:acd3cd9ec15fdceb68c5516f59552605c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Call on a succesful run through main loop. Decrements error counter on succesful run through main loop. <br /></td></tr>
<tr class="separator:acd3cd9ec15fdceb68c5516f59552605c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae1d79ed043eedc99cbc01f7c59ce369e"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#ae1d79ed043eedc99cbc01f7c59ce369e">filterCellVoltages</a> (float *cellVoltages, float *<a class="el" href="batteries_8c.html#afa99b901194e86a7784f6213f9420089">cellVoltagesFiltered</a>)</td></tr>
<tr class="memdesc:ae1d79ed043eedc99cbc01f7c59ce369e"><td class="mdescLeft">&#160;</td><td class="mdescRight">This takes an array of the instantaneous cell volages, and filters them on an ongoing basis using the cellVoltagesFiltered array. For check cell voltages, a filtered version of cell voltages is needed to eliminate noise due to bad contact with AMS boards. The hypothesis is that the pogo pins make bad contact with the ams boards when the motors spin, thus the need for filtering. This hasn't been proven however, but the filtering fixed the errors we saw before (info up to date as of May 2020) NB: Filter voltages shouldn't be sent over CAN, only used with error checking.  <a href="batteries_8c.html#ae1d79ed043eedc99cbc01f7c59ce369e">More...</a><br /></td></tr>
<tr class="separator:ae1d79ed043eedc99cbc01f7c59ce369e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7090234402b08bb512cf5db06702c9f0"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a7090234402b08bb512cf5db06702c9f0">checkCellVoltagesAndTemps</a> (float *maxVoltage, float *minVoltage, float *maxTemp, float *minTemp, float *packVoltage)</td></tr>
<tr class="memdesc:a7090234402b08bb512cf5db06702c9f0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Checks cell voltages and temperatures to ensure they are within safe limits, as well as sending out warnings when the values get close to their limits and updating max/min voltages/temps and calculated pack voltage NB: This skips checking temperatures of cells specified as having faulty measurements in <a class="el" href="batteries_8c.html#a4bb357024aa0bb23dcfba57009d3f836">isTempCellWorking</a> array.  <a href="batteries_8c.html#a7090234402b08bb512cf5db06702c9f0">More...</a><br /></td></tr>
<tr class="separator:a7090234402b08bb512cf5db06702c9f0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6b2f1ad817d75d1c5c590814371b5062"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a6b2f1ad817d75d1c5c590814371b5062">calculateStateOfPower</a> ()</td></tr>
<tr class="memdesc:a6b2f1ad817d75d1c5c590814371b5062"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates the state of power of the battery pack. TODO: this calculation is from 2017, so should be updated for the 2020 pack.  <a href="batteries_8c.html#a6b2f1ad817d75d1c5c590814371b5062">More...</a><br /></td></tr>
<tr class="separator:a6b2f1ad817d75d1c5c590814371b5062"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7b0e95f68b412d5d5e9620ffbae8750d"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a7b0e95f68b412d5d5e9620ffbae8750d">calculateStateOfCharge</a> ()</td></tr>
<tr class="memdesc:a7b0e95f68b412d5d5e9620ffbae8750d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates the state of charge of the battery pack. This is a measure of how much capacity the pack has left on its current charge. Currently its implemented as a simple ratio of min cell voltage versus safe limits.  <a href="batteries_8c.html#a7b0e95f68b412d5d5e9620ffbae8750d">More...</a><br /></td></tr>
<tr class="separator:a7b0e95f68b412d5d5e9620ffbae8750d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeb2f305c6977c16734384de553edfa73"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#aeb2f305c6977c16734384de553edfa73">batteryStart</a> ()</td></tr>
<tr class="memdesc:aeb2f305c6977c16734384de553edfa73"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initializes the battery task.  <a href="batteries_8c.html#aeb2f305c6977c16734384de553edfa73">More...</a><br /></td></tr>
<tr class="separator:aeb2f305c6977c16734384de553edfa73"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afa698a16023626be583ce5082c76f5ec"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#afa698a16023626be583ce5082c76f5ec">publishPackVoltage</a> (float packVoltage)</td></tr>
<tr class="memdesc:afa698a16023626be583ce5082c76f5ec"><td class="mdescLeft">&#160;</td><td class="mdescRight">Publishes the current pack voltage value to the queue for other tasks to read from.  <a href="batteries_8c.html#afa698a16023626be583ce5082c76f5ec">More...</a><br /></td></tr>
<tr class="separator:afa698a16023626be583ce5082c76f5ec"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab07aef73f633627b5a1a78e40f15961f"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#ab07aef73f633627b5a1a78e40f15961f">getPackVoltage</a> (float *packVoltage)</td></tr>
<tr class="memdesc:ab07aef73f633627b5a1a78e40f15961f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Gets the current pack voltage. This returns the pack voltage as calculated by summing all the cell voltages.  <a href="batteries_8c.html#ab07aef73f633627b5a1a78e40f15961f">More...</a><br /></td></tr>
<tr class="separator:ab07aef73f633627b5a1a78e40f15961f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a92932081ca58208175ca6c4e0971f06d"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a92932081ca58208175ca6c4e0971f06d">initPackVoltageQueue</a> ()</td></tr>
<tr class="memdesc:a92932081ca58208175ca6c4e0971f06d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Creates the pack voltage queue. Needs to be called before RTOS starts.  <a href="batteries_8c.html#a92932081ca58208175ca6c4e0971f06d">More...</a><br /></td></tr>
<tr class="separator:a92932081ca58208175ca6c4e0971f06d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aacf3b5ff9648b813208cb6f91b370fef"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#aacf3b5ff9648b813208cb6f91b370fef">setMaxChargeCurrent</a> (float maxCurrent)</td></tr>
<tr class="memdesc:aacf3b5ff9648b813208cb6f91b370fef"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sets the maximum current for the charger.  <a href="batteries_8c.html#aacf3b5ff9648b813208cb6f91b370fef">More...</a><br /></td></tr>
<tr class="separator:aacf3b5ff9648b813208cb6f91b370fef"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a43ea41cc1c21bd36b3622076e20b596c"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a43ea41cc1c21bd36b3622076e20b596c">startCharging</a> ()</td></tr>
<tr class="memdesc:a43ea41cc1c21bd36b3622076e20b596c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sends the maximum charge current and voltage to the charger and waits for the charger to start charging.  <a href="batteries_8c.html#a43ea41cc1c21bd36b3622076e20b596c">More...</a><br /></td></tr>
<tr class="separator:a43ea41cc1c21bd36b3622076e20b596c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a533907b25f7b1dbb355151d336ed9ff6"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a533907b25f7b1dbb355151d336ed9ff6">continueCharging</a> ()</td></tr>
<tr class="memdesc:a533907b25f7b1dbb355151d336ed9ff6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sends messages to the charger. The charger expects a message every second so this needs to be repeatedly called during charging.  <a href="batteries_8c.html#a533907b25f7b1dbb355151d336ed9ff6">More...</a><br /></td></tr>
<tr class="separator:a533907b25f7b1dbb355151d336ed9ff6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5cf6c235603af078c2dc841ae579f3b5"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a5cf6c235603af078c2dc841ae579f3b5">stopCharging</a> ()</td></tr>
<tr class="memdesc:a5cf6c235603af078c2dc841ae579f3b5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sends a command to the charger to stop charging.  <a href="batteries_8c.html#a5cf6c235603af078c2dc841ae579f3b5">More...</a><br /></td></tr>
<tr class="separator:a5cf6c235603af078c2dc841ae579f3b5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad54912c48ac30fc66796b2aeca58cea7"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#ad54912c48ac30fc66796b2aeca58cea7">stopBalance</a> ()</td></tr>
<tr class="memdesc:ad54912c48ac30fc66796b2aeca58cea7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stops all cells balancing by sending command to AMS boards.  <a href="batteries_8c.html#ad54912c48ac30fc66796b2aeca58cea7">More...</a><br /></td></tr>
<tr class="separator:ad54912c48ac30fc66796b2aeca58cea7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa04706789e98d82797970064b10dd0c9"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#aa04706789e98d82797970064b10dd0c9">pauseBalance</a> ()</td></tr>
<tr class="memdesc:aa04706789e98d82797970064b10dd0c9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stops all cells balancing, but stores which cells were balancing to allowing resuming of balance for cells that were balancing.  <a href="batteries_8c.html#aa04706789e98d82797970064b10dd0c9">More...</a><br /></td></tr>
<tr class="separator:aa04706789e98d82797970064b10dd0c9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a82969943d42e6067b966c64c61196dcd"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a82969943d42e6067b966c64c61196dcd">resumeBalance</a> ()</td></tr>
<tr class="memdesc:a82969943d42e6067b966c64c61196dcd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Resumes balancing after call to <a class="el" href="batteries_8c.html#aa04706789e98d82797970064b10dd0c9">pauseBalance</a>.  <a href="batteries_8c.html#a82969943d42e6067b966c64c61196dcd">More...</a><br /></td></tr>
<tr class="separator:a82969943d42e6067b966c64c61196dcd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaacb3ffbd5367bbde01d4e8120fdbea0"><td class="memItemLeft" align="right" valign="top">HAL_StatusTypeDef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#aaacb3ffbd5367bbde01d4e8120fdbea0">balance_cell</a> (int cell, bool set)</td></tr>
<tr class="memdesc:aaacb3ffbd5367bbde01d4e8120fdbea0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Control the balance state of an individual cell. NB: this is inneficient if balancing multiple cells, as he entire balance config is sent to the AMS boards every time this is called. Instead, use the lower level batt_balance_cell/batt_stop_balance_cell to change state for all cells, then call batt_write_config to send the new balance config.  <a href="batteries_8c.html#aaacb3ffbd5367bbde01d4e8120fdbea0">More...</a><br /></td></tr>
<tr class="separator:aaacb3ffbd5367bbde01d4e8120fdbea0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aed5d06c4a55e40673204ceacf2fde819"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#aed5d06c4a55e40673204ceacf2fde819">map_range_float</a> (float in, float low, float high, float low_out, float high_out)</td></tr>
<tr class="memdesc:aed5d06c4a55e40673204ceacf2fde819"><td class="mdescLeft">&#160;</td><td class="mdescRight">Maps a value from one range to another in a linear manner.  <a href="batteries_8c.html#aed5d06c4a55e40673204ceacf2fde819">More...</a><br /></td></tr>
<tr class="separator:aed5d06c4a55e40673204ceacf2fde819"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3d41850a2fe8400978c4f68163d726be"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a3d41850a2fe8400978c4f68163d726be">getSOCFromVoltage</a> (float cellVoltage)</td></tr>
<tr class="memdesc:a3d41850a2fe8400978c4f68163d726be"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates the SoC of a cell from the cell's voltage.  <a href="batteries_8c.html#a3d41850a2fe8400978c4f68163d726be">More...</a><br /></td></tr>
<tr class="separator:a3d41850a2fe8400978c4f68163d726be"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9144cd162ceec3e710baea6601149b43"><td class="memItemLeft" align="right" valign="top"><a class="el" href="batteries_8c.html#a2f80b01711da374b25803fa818de09b1">ChargeReturn</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a9144cd162ceec3e710baea6601149b43">balanceCharge</a> ()</td></tr>
<tr class="memdesc:a9144cd162ceec3e710baea6601149b43"><td class="mdescLeft">&#160;</td><td class="mdescRight">Performs balance charging. For more info, see the BMU page on confluence.  <a href="batteries_8c.html#a9144cd162ceec3e710baea6601149b43">More...</a><br /></td></tr>
<tr class="separator:a9144cd162ceec3e710baea6601149b43"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3364449b5cc8a93c89985f5d9fa2984b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a3364449b5cc8a93c89985f5d9fa2984b">batteryTask</a> (void *pvParameter)</td></tr>
<tr class="memdesc:a3364449b5cc8a93c89985f5d9fa2984b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Task to monitor cell voltages and temperatures, as well as perform balance charging.  <a href="batteries_8c.html#a3364449b5cc8a93c89985f5d9fa2984b">More...</a><br /></td></tr>
<tr class="separator:a3364449b5cc8a93c89985f5d9fa2984b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd55a62448b408952283c28d12dd4c1d"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#acd55a62448b408952283c28d12dd4c1d">setSendOnlyOneCell</a> (int cellIdx)</td></tr>
<tr class="memdesc:acd55a62448b408952283c28d12dd4c1d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Repeatedly send the cell voltage and temperature for a specific cell. This is instead of the normal behaviour which cycles through all the cells sending a message every <a class="el" href="batteries_8c.html#ab75dbcd7e0a59fc3d1fc3715de87544a">CAN_CELL_SEND_PERIOD_MS</a>. Useful for battery testing to monitor a cell at higher frequency.  <a href="batteries_8c.html#acd55a62448b408952283c28d12dd4c1d">More...</a><br /></td></tr>
<tr class="separator:acd55a62448b408952283c28d12dd4c1d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ade4720060f19979c4071eae3fb08ff92"><td class="memItemLeft" align="right" valign="top"><a id="ade4720060f19979c4071eae3fb08ff92"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#ade4720060f19979c4071eae3fb08ff92">clearSendOnlyOneCell</a> ()</td></tr>
<tr class="memdesc:ade4720060f19979c4071eae3fb08ff92"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stop sending only one cell repeatedly, and go back to sending all cells over CAN. <br /></td></tr>
<tr class="separator:ade4720060f19979c4071eae3fb08ff92"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a445bbbf2332f3c63a4bfcddf4b78ff43"><td class="memItemLeft" align="right" valign="top"><a id="a445bbbf2332f3c63a4bfcddf4b78ff43"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a445bbbf2332f3c63a4bfcddf4b78ff43">canSendCellTask</a> (void *pvParameters)</td></tr>
<tr class="memdesc:a445bbbf2332f3c63a4bfcddf4b78ff43"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sends the cell voltages and temperatures over CAN. <br /></td></tr>
<tr class="separator:a445bbbf2332f3c63a4bfcddf4b78ff43"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:aa95731d4ff40893bc5d4c80cc0fa055f"><td class="memItemLeft" align="right" valign="top"><a id="aa95731d4ff40893bc5d4c80cc0fa055f"></a>
osThreadId&#160;</td><td class="memItemRight" valign="bottom"><b>BatteryTaskHandle</b></td></tr>
<tr class="separator:aa95731d4ff40893bc5d4c80cc0fa055f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a098ac94ec41c0b74569366cf7660c680"><td class="memItemLeft" align="right" valign="top"><a id="a098ac94ec41c0b74569366cf7660c680"></a>
float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a098ac94ec41c0b74569366cf7660c680">maxChargeCurrent</a> = <a class="el" href="batteries_8c.html#a68aaf77b085834ea0c03a6ab2e2910f6">CHARGE_DEFAULT_MAX_CURRENT</a></td></tr>
<tr class="memdesc:a098ac94ec41c0b74569366cf7660c680"><td class="mdescLeft">&#160;</td><td class="mdescRight">Charging current limit. <br /></td></tr>
<tr class="separator:a098ac94ec41c0b74569366cf7660c680"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1e19984c8df58b545da1c8f8b5547acd"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a1e19984c8df58b545da1c8f8b5547acd">maxChargeVoltage</a> = LIMIT_OVERVOLTAGE * VOLTAGECELL_COUNT</td></tr>
<tr class="separator:a1e19984c8df58b545da1c8f8b5547acd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afeb7e3ce5be75e8a7d03ae9bbc3c2150"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#afeb7e3ce5be75e8a7d03ae9bbc3c2150">warningSentForCellVoltage</a> [VOLTAGECELL_COUNT]</td></tr>
<tr class="separator:afeb7e3ce5be75e8a7d03ae9bbc3c2150"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a61bd11f0a0377192a9a1950e18664728"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a61bd11f0a0377192a9a1950e18664728">warningSentForCellTemp</a> [TEMPCELL_COUNT]</td></tr>
<tr class="separator:a61bd11f0a0377192a9a1950e18664728"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4bb357024aa0bb23dcfba57009d3f836"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a4bb357024aa0bb23dcfba57009d3f836">isTempCellWorking</a> [TEMPCELL_COUNT]</td></tr>
<tr class="separator:a4bb357024aa0bb23dcfba57009d3f836"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab483cabe57068f7e0fd4bcaee6c1fb59"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#ab483cabe57068f7e0fd4bcaee6c1fb59">voltageToSOCLookup</a> [NUM_SOC_LOOKUP_VALS]</td></tr>
<tr class="separator:ab483cabe57068f7e0fd4bcaee6c1fb59"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a141159dacb84bda6d1ce0a156c258177"><td class="memItemLeft" align="right" valign="top"><a id="a141159dacb84bda6d1ce0a156c258177"></a>
QueueHandle_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a141159dacb84bda6d1ce0a156c258177">IBusQueue</a></td></tr>
<tr class="memdesc:a141159dacb84bda6d1ce0a156c258177"><td class="mdescLeft">&#160;</td><td class="mdescRight">Queue holding most recent bus current measurement. <br /></td></tr>
<tr class="separator:a141159dacb84bda6d1ce0a156c258177"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abafdcf601bccb3238fcb8534b517d130"><td class="memItemLeft" align="right" valign="top"><a id="abafdcf601bccb3238fcb8534b517d130"></a>
QueueHandle_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#abafdcf601bccb3238fcb8534b517d130">VBusQueue</a></td></tr>
<tr class="memdesc:abafdcf601bccb3238fcb8534b517d130"><td class="mdescLeft">&#160;</td><td class="mdescRight">Queue holding most recent bus volage measurement. <br /></td></tr>
<tr class="separator:abafdcf601bccb3238fcb8534b517d130"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad64f368c4f439a41338c59c0c4b685e2"><td class="memItemLeft" align="right" valign="top"><a id="ad64f368c4f439a41338c59c0c4b685e2"></a>
QueueHandle_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#ad64f368c4f439a41338c59c0c4b685e2">VBattQueue</a></td></tr>
<tr class="memdesc:ad64f368c4f439a41338c59c0c4b685e2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Queue holding most recent battery voltage measurement. <br /></td></tr>
<tr class="separator:ad64f368c4f439a41338c59c0c4b685e2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a17c95138c88cf1a7a64a0dd006730b6c"><td class="memItemLeft" align="right" valign="top"><a id="a17c95138c88cf1a7a64a0dd006730b6c"></a>
QueueHandle_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a17c95138c88cf1a7a64a0dd006730b6c">PackVoltageQueue</a></td></tr>
<tr class="memdesc:a17c95138c88cf1a7a64a0dd006730b6c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Queue holding most recent battery voltage (calculated from sum of cell voltages) measurement. <br /></td></tr>
<tr class="separator:a17c95138c88cf1a7a64a0dd006730b6c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afa99b901194e86a7784f6213f9420089"><td class="memItemLeft" align="right" valign="top"><a id="afa99b901194e86a7784f6213f9420089"></a>
float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#afa99b901194e86a7784f6213f9420089">cellVoltagesFiltered</a> [VOLTAGECELL_COUNT]</td></tr>
<tr class="memdesc:afa99b901194e86a7784f6213f9420089"><td class="mdescLeft">&#160;</td><td class="mdescRight">Array is used to store the filtered voltages. <br /></td></tr>
<tr class="separator:afa99b901194e86a7784f6213f9420089"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a58c53a03f6ed59b66477d9ff778a7ec1"><td class="memItemLeft" align="right" valign="top"><a id="a58c53a03f6ed59b66477d9ff778a7ec1"></a>
bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="batteries_8c.html#a58c53a03f6ed59b66477d9ff778a7ec1">isCellBalancing</a> [VOLTAGECELL_COUNT] = {0}</td></tr>
<tr class="memdesc:a58c53a03f6ed59b66477d9ff778a7ec1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Array to store if a cell is balancing. <br /></td></tr>
<tr class="separator:a58c53a03f6ed59b66477d9ff778a7ec1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a08165bcd985456a8bb4f39d29b0132d8"><td class="memItemLeft" align="right" valign="top"><a id="a08165bcd985456a8bb4f39d29b0132d8"></a>
bool&#160;</td><td class="memItemRight" valign="bottom"><b>sendOneCellVoltAndTemp</b> = false</td></tr>
<tr class="separator:a08165bcd985456a8bb4f39d29b0132d8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a45eac5b187ae199e0de1fa376e2024b3"><td class="memItemLeft" align="right" valign="top"><a id="a45eac5b187ae199e0de1fa376e2024b3"></a>
int&#160;</td><td class="memItemRight" valign="bottom"><b>cellToSend</b></td></tr>
<tr class="separator:a45eac5b187ae199e0de1fa376e2024b3"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Battery Monitoring, Charging, HV Bus Sense, IMD monitor. </p>
<dl class="section author"><dt>Author</dt><dd>Richard Matthews</dd></dl>
<p>This file contains a number of tasks and related functions:</p><ul>
<li>Battery Monitoring and Charging (batteryTask): Monitors the voltage and temperature of all cells by communicating with the AMS boards, performs balance charging and communicates with the charger over CAN</li>
<li>HV Bus Sense (HVMeasureTask): Measures the voltage and current on the HV Bus as well as the HV battery pack voltage</li>
<li>IMD Monitoring (imdTask): Measures the signals from the insulation monitoring device (IMD) to check for insulation faults</li>
<li>canSendCellTask: Sends the cell voltage and temperatures over CAN using the multiplexed CAN messages </li>
</ul>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="aaa9233fe54ffd66274a5dd46390b36e5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaa9233fe54ffd66274a5dd46390b36e5">&#9670;&nbsp;</a></span>BALANCE_RECHECK_PERIOD_MS</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BALANCE_RECHECK_PERIOD_MS&#160;&#160;&#160;(3000)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Period at which cell SoCs are checked to determine which cells to balance. This should be long enough so cells aren't constantly being toggled between balance and not </p>

</div>
</div>
<a id="a9b3fe58b53cbf8d5fbc53709ed5a278b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9b3fe58b53cbf8d5fbc53709ed5a278b">&#9670;&nbsp;</a></span>CELL_VOLTAGE_FILTER_ALPHA</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CELL_VOLTAGE_FILTER_ALPHA&#160;&#160;&#160;0.18</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Alpha value for cell voltage filter For a 10-90 rise time of 1 sec, set the bandwidth to 0.35 Hz See: <a href="https://www.edn.com/electronics-blogs/bogatin-s-rules-of-thumb/4424573/Rule-of-Thumb&ndash;1&ndash;The-bandwidth-of-a-signal-from-its-rise-time">https://www.edn.com/electronics-blogs/bogatin-s-rules-of-thumb/4424573/Rule-of-Thumb&amp;ndash;1&amp;ndash;The-bandwidth-of-a-signal-from-its-rise-time</a> This cuttoff, with a sampling frequency of 100 ms gives an alpha of 0.18 See the wikipedia page for the alpha calculation: <a href="https://en.wikipedia.org/wiki/Low-pass_filter#Simple_infinite_impulse_response_filter">https://en.wikipedia.org/wiki/Low-pass_filter#Simple_infinite_impulse_response_filter</a> </p>

</div>
</div>
<a id="a3840db84d2eaac3f4fe59941e21ff410"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3840db84d2eaac3f4fe59941e21ff410">&#9670;&nbsp;</a></span>CHARGE_CART_HEARTBEAT_MAX_PERIOD</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CHARGE_CART_HEARTBEAT_MAX_PERIOD&#160;&#160;&#160;(1000)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>If using charge cart heartbeat, this heartbeat timeout. NB: We are phasing out use of charge cart as a board with a microcontroller </p>

</div>
</div>
<h2 class="groupheader">Typedef Documentation</h2>
<a id="a57d972b2a0b68887bd7afab4c1d2553f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a57d972b2a0b68887bd7afab4c1d2553f">&#9670;&nbsp;</a></span>ChargeReturn</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef enum <a class="el" href="batteries_8c.html#a2f80b01711da374b25803fa818de09b1">ChargeReturn</a> <a class="el" href="batteries_8c.html#a2f80b01711da374b25803fa818de09b1">ChargeReturn</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Return of balance charge function </p>

</div>
</div>
<h2 class="groupheader">Enumeration Type Documentation</h2>
<a id="a2f80b01711da374b25803fa818de09b1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2f80b01711da374b25803fa818de09b1">&#9670;&nbsp;</a></span>ChargeReturn</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="batteries_8c.html#a2f80b01711da374b25803fa818de09b1">ChargeReturn</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Return of balance charge function </p>
<table class="fieldtable">
<tr><th colspan="2">Enumerator</th></tr><tr><td class="fieldname"><a id="a2f80b01711da374b25803fa818de09b1a0abf13e2a7d6435eb5b31d33abeadad7"></a>CHARGE_DONE&#160;</td><td class="fielddoc"><p>Charging finished, cells reached fully charged. </p>
</td></tr>
<tr><td class="fieldname"><a id="a2f80b01711da374b25803fa818de09b1a3db9c119e634b77566daafdde61b29f1"></a>CHARGE_STOPPED&#160;</td><td class="fielddoc"><p>Charging was stopped as requested, cells not fully charged. </p>
</td></tr>
<tr><td class="fieldname"><a id="a2f80b01711da374b25803fa818de09b1ad0605183af862ee76169e8b41c7fd927"></a>CHARGE_ERROR&#160;</td><td class="fielddoc"><p>Error occured stopping charging, cells not fully charged. </p>
</td></tr>
</table>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="aaacb3ffbd5367bbde01d4e8120fdbea0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaacb3ffbd5367bbde01d4e8120fdbea0">&#9670;&nbsp;</a></span>balance_cell()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef balance_cell </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>cell</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>set</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Control the balance state of an individual cell. NB: this is inneficient if balancing multiple cells, as he entire balance config is sent to the AMS boards every time this is called. Instead, use the lower level batt_balance_cell/batt_stop_balance_cell to change state for all cells, then call batt_write_config to send the new balance config. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">cell</td><td>The cell to change the balance state of </td></tr>
    <tr><td class="paramname">set</td><td>True if should balance cell</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="a9144cd162ceec3e710baea6601149b43"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9144cd162ceec3e710baea6601149b43">&#9670;&nbsp;</a></span>balanceCharge()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="batteries_8c.html#a2f80b01711da374b25803fa818de09b1">ChargeReturn</a> balanceCharge </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Performs balance charging. For more info, see the BMU page on confluence. </p>
<dl class="section return"><dt>Returns</dt><dd><a class="el" href="batteries_8c.html#a57d972b2a0b68887bd7afab4c1d2553f">ChargeReturn</a> </dd></dl>

</div>
</div>
<a id="aeb2f305c6977c16734384de553edfa73"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aeb2f305c6977c16734384de553edfa73">&#9670;&nbsp;</a></span>batteryStart()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef batteryStart </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initializes the battery task. </p>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="a3364449b5cc8a93c89985f5d9fa2984b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3364449b5cc8a93c89985f5d9fa2984b">&#9670;&nbsp;</a></span>batteryTask()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void batteryTask </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>pvParameter</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Task to monitor cell voltages and temperatures, as well as perform balance charging. </p>
<p>!! Change the check in in bounded continue as well if you change this</p>

</div>
</div>
<a id="a796b02ffebbe6ba22dca62df11bcb05c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a796b02ffebbe6ba22dca62df11bcb05c">&#9670;&nbsp;</a></span>boundedContinue()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool boundedContinue </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Called by battery task it an error is encountered that is not immediately fatal. This causes the task to retry its readings/whatever else failed MAX_ERROR_COUNT times, then fail and send error event. TODO: ensure this is max 500 ms to meet rules for cell reading times. </p>
<dl class="section return"><dt>Returns</dt><dd>true if errorCounter is below or equal to max error count, false otherwise </dd></dl>

</div>
</div>
<a id="a7b0e95f68b412d5d5e9620ffbae8750d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7b0e95f68b412d5d5e9620ffbae8750d">&#9670;&nbsp;</a></span>calculateStateOfCharge()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float calculateStateOfCharge </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculates the state of charge of the battery pack. This is a measure of how much capacity the pack has left on its current charge. Currently its implemented as a simple ratio of min cell voltage versus safe limits. </p>
<dl class="section return"><dt>Returns</dt><dd>State of Charge (percent) </dd></dl>

</div>
</div>
<a id="a6b2f1ad817d75d1c5c590814371b5062"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6b2f1ad817d75d1c5c590814371b5062">&#9670;&nbsp;</a></span>calculateStateOfPower()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float calculateStateOfPower </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculates the state of power of the battery pack. TODO: this calculation is from 2017, so should be updated for the 2020 pack. </p>
<dl class="section return"><dt>Returns</dt><dd>The state of power of the battery pack (in Watts?) </dd></dl>

</div>
</div>
<a id="a7090234402b08bb512cf5db06702c9f0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7090234402b08bb512cf5db06702c9f0">&#9670;&nbsp;</a></span>checkCellVoltagesAndTemps()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef checkCellVoltagesAndTemps </td>
          <td>(</td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>maxVoltage</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>minVoltage</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>maxTemp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>minTemp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>packVoltage</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Checks cell voltages and temperatures to ensure they are within safe limits, as well as sending out warnings when the values get close to their limits and updating max/min voltages/temps and calculated pack voltage NB: This skips checking temperatures of cells specified as having faulty measurements in <a class="el" href="batteries_8c.html#a4bb357024aa0bb23dcfba57009d3f836">isTempCellWorking</a> array. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[out]</td><td class="paramname">maxVoltage</td><td>The cell voltage of the cell with the max voltage </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">minVoltage</td><td>The cell voltage of the cell with the min voltage </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">maxTemp</td><td>The cell temperature of the cell with the max temperature </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">minTemp</td><td>The cell temperature of the cell with the min temperature </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">packVoltage</td><td>The sum of all the cell voltages, which should be the output voltage of the pack</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="a19d5fb02c3547746d76a121bf9f10807"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a19d5fb02c3547746d76a121bf9f10807">&#9670;&nbsp;</a></span>cliSetIBus()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef cliSetIBus </td>
          <td>(</td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>IBus</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>For nucleo testing, allows setting a dummy value for the IBus reading. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">IBus</td><td>The value to set for IBus, in volts</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="a6e1bc0d2209bd309c4db0a06009a339a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6e1bc0d2209bd309c4db0a06009a339a">&#9670;&nbsp;</a></span>cliSetVBatt()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef cliSetVBatt </td>
          <td>(</td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>VBatt</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>For nucleo testing, allows setting a dummy value for the VBatt reading. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VBatt</td><td>The value to set for VBatt, in volts</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="a2ab7e555695e672e38894f394a31a3ef"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2ab7e555695e672e38894f394a31a3ef">&#9670;&nbsp;</a></span>cliSetVBus()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef cliSetVBus </td>
          <td>(</td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>VBus</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>For nucleo testing, allows setting a dummy value for the VBus reading. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VBus</td><td>The value to set for VBus, in volts</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="a533907b25f7b1dbb355151d336ed9ff6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a533907b25f7b1dbb355151d336ed9ff6">&#9670;&nbsp;</a></span>continueCharging()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef continueCharging </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sends messages to the charger. The charger expects a message every second so this needs to be repeatedly called during charging. </p>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="ae1d79ed043eedc99cbc01f7c59ce369e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae1d79ed043eedc99cbc01f7c59ce369e">&#9670;&nbsp;</a></span>filterCellVoltages()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void filterCellVoltages </td>
          <td>(</td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>cellVoltages</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>cellVoltagesFiltered</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This takes an array of the instantaneous cell volages, and filters them on an ongoing basis using the cellVoltagesFiltered array. For check cell voltages, a filtered version of cell voltages is needed to eliminate noise due to bad contact with AMS boards. The hypothesis is that the pogo pins make bad contact with the ams boards when the motors spin, thus the need for filtering. This hasn't been proven however, but the filtering fixed the errors we saw before (info up to date as of May 2020) NB: Filter voltages shouldn't be sent over CAN, only used with error checking. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">cellVoltages</td><td>unfiltered cell voltage readings </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">cellVoltagesFiltered</td><td>filtered cell voltage readings </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a1300d8fea84c20d3945380460f61f81d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1300d8fea84c20d3945380460f61f81d">&#9670;&nbsp;</a></span>filterIBus()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float filterIBus </td>
          <td>(</td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>IBus</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Low pass filters the HV Bus current measurement. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">IBus</td><td>the measured HV Bus current </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The filtered HV Bus current </dd></dl>

</div>
</div>
<a id="a0ee7fbdeb8e2e8413b4fc77ba59223d5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0ee7fbdeb8e2e8413b4fc77ba59223d5">&#9670;&nbsp;</a></span>getIBus()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef getIBus </td>
          <td>(</td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>IBus</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get the most recent bus current reading. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[out]</td><td class="paramname">IBus</td><td>pointer to a float to store the IBus reading, in amps</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="ab07aef73f633627b5a1a78e40f15961f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab07aef73f633627b5a1a78e40f15961f">&#9670;&nbsp;</a></span>getPackVoltage()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef getPackVoltage </td>
          <td>(</td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>packVoltage</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Gets the current pack voltage. This returns the pack voltage as calculated by summing all the cell voltages. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">packVoltage</td><td>pointer to a float to return the pack voltage (in volts)</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDe </dd></dl>

</div>
</div>
<a id="a3d41850a2fe8400978c4f68163d726be"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3d41850a2fe8400978c4f68163d726be">&#9670;&nbsp;</a></span>getSOCFromVoltage()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float getSOCFromVoltage </td>
          <td>(</td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>cellVoltage</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculates the SoC of a cell from the cell's voltage. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">cellVoltage</td><td>The cell voltage</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the SoC of the cell in percent (0-100) </dd></dl>

</div>
</div>
<a id="aff30116cb629c2efdad61c2ccaec0c36"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aff30116cb629c2efdad61c2ccaec0c36">&#9670;&nbsp;</a></span>getVBatt()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef getVBatt </td>
          <td>(</td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>VBatt</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get the most recent battery voltage reading (from the HV ADC). Note: this is only equal to the battery voltage when both contactors are closed. to get the battery voltage in all times, use <a class="el" href="batteries_8c.html#ab07aef73f633627b5a1a78e40f15961f">getPackVoltage</a>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[out]</td><td class="paramname">pointer</td><td>to a float to store the VBatt reading, in volts</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="a6fbf3bf910348af26a580fc418f89f5e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6fbf3bf910348af26a580fc418f89f5e">&#9670;&nbsp;</a></span>getVBus()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef getVBus </td>
          <td>(</td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>VBus</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get the most recent HV Bus voltage reading (from the HV ADC) </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[out]</td><td class="paramname">pointer</td><td>to a float to store the VBus reading, in volts</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="a1ef8191389452a8f21cb2d02b20cba29"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1ef8191389452a8f21cb2d02b20cba29">&#9670;&nbsp;</a></span>HVMeasureTask()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void HVMeasureTask </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>pvParamaters</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Measures the voltage and current on the HV Bus as well as the HV battery pack voltage. Note that the HV battery pack voltage (VBatt) is only equal to the actual pack voltage in ceraint contactor states, see prechargeDischarge procedure on confluence for more info. Instead, use <a class="el" href="batteries_8c.html#ab07aef73f633627b5a1a78e40f15961f">getPackVoltage</a> which bases it measurement on the sum of cell voltages </p>

</div>
</div>
<a id="a92932081ca58208175ca6c4e0971f06d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a92932081ca58208175ca6c4e0971f06d">&#9670;&nbsp;</a></span>initPackVoltageQueue()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef initPackVoltageQueue </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Creates the pack voltage queue. Needs to be called before RTOS starts. </p>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="aed5d06c4a55e40673204ceacf2fde819"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aed5d06c4a55e40673204ceacf2fde819">&#9670;&nbsp;</a></span>map_range_float()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float map_range_float </td>
          <td>(</td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>low</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>high</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>low_out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>high_out</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Maps a value from one range to another in a linear manner. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">in</td><td>The value to map </td></tr>
    <tr><td class="paramname">low</td><td>low value of in range </td></tr>
    <tr><td class="paramname">high</td><td>high value of in range </td></tr>
    <tr><td class="paramname">low_out</td><td>low value of out range </td></tr>
    <tr><td class="paramname">high_out</td><td>high value of out range</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>in value mapped to out range </dd></dl>

</div>
</div>
<a id="aa04706789e98d82797970064b10dd0c9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa04706789e98d82797970064b10dd0c9">&#9670;&nbsp;</a></span>pauseBalance()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef pauseBalance </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Stops all cells balancing, but stores which cells were balancing to allowing resuming of balance for cells that were balancing. </p>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="a37d4140213dc1708776032fc935e0b39"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a37d4140213dc1708776032fc935e0b39">&#9670;&nbsp;</a></span>publishBusVoltagesAndCurrent()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef publishBusVoltagesAndCurrent </td>
          <td>(</td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>pIBus</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>pVBus</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>pVBatt</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Publishes the most recent HV Bus measurements to queues for other tasks to read from Queue overwrite, Queue peek, and queue size of 1 is used to ensure only the most recent data is in the queue and read from the queue. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">pIbus</td><td>pointer to the HV bus current measurement (in Amps) </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">pVbus</td><td>pointer to the HV bus voltage measurement (in Volts) </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">pVbatt</td><td>pointer to the HV battery voltage measurement (in Volts) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="afa698a16023626be583ce5082c76f5ec"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afa698a16023626be583ce5082c76f5ec">&#9670;&nbsp;</a></span>publishPackVoltage()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef publishPackVoltage </td>
          <td>(</td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>packVoltage</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Publishes the current pack voltage value to the queue for other tasks to read from. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">packVoltage</td><td>The current pack voltage in volts</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="a4d72951e5a03e396bb864b5c45bda0f0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4d72951e5a03e396bb864b5c45bda0f0">&#9670;&nbsp;</a></span>readBusVoltagesAndCurrents()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef readBusVoltagesAndCurrents </td>
          <td>(</td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>IBus</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>VBus</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>VBatt</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Measures HV voltages and currents using the HV ADC. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[out]</td><td class="paramname">Ibus</td><td>pointer to the HV bus current measurement (in Amps) </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">Vbus</td><td>pointer to the HV bus voltage measurement (in Volts) </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">Vbatt</td><td>pointer to the HV battery voltage measurement (in Volts)</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="a36a3c81e474331b59839cb2f565c7704"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a36a3c81e474331b59839cb2f565c7704">&#9670;&nbsp;</a></span>readCellVoltagesAndTemps()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef readCellVoltagesAndTemps </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Reads the cell voltages and temperatures from the AMS boards. The battery temperature and cell voltages are stored in the global arrays which are also used for sending them over CAN. </p>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="a82969943d42e6067b966c64c61196dcd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a82969943d42e6067b966c64c61196dcd">&#9670;&nbsp;</a></span>resumeBalance()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef resumeBalance </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Resumes balancing after call to <a class="el" href="batteries_8c.html#aa04706789e98d82797970064b10dd0c9">pauseBalance</a>. </p>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="aacf3b5ff9648b813208cb6f91b370fef"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aacf3b5ff9648b813208cb6f91b370fef">&#9670;&nbsp;</a></span>setMaxChargeCurrent()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef setMaxChargeCurrent </td>
          <td>(</td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>maxCurrent</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sets the maximum current for the charger. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">maxCurrent</td><td>The maximum current, in Amps</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="acd55a62448b408952283c28d12dd4c1d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acd55a62448b408952283c28d12dd4c1d">&#9670;&nbsp;</a></span>setSendOnlyOneCell()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setSendOnlyOneCell </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>cellIdx</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Repeatedly send the cell voltage and temperature for a specific cell. This is instead of the normal behaviour which cycles through all the cells sending a message every <a class="el" href="batteries_8c.html#ab75dbcd7e0a59fc3d1fc3715de87544a">CAN_CELL_SEND_PERIOD_MS</a>. Useful for battery testing to monitor a cell at higher frequency. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">cellIdx</td><td>The cell to repeatedly send (note, this uses firmwares 0 based indexing, instead of electricals 1 based indexing of cell numbers) </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a43ea41cc1c21bd36b3622076e20b596c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a43ea41cc1c21bd36b3622076e20b596c">&#9670;&nbsp;</a></span>startCharging()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef startCharging </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sends the maximum charge current and voltage to the charger and waits for the charger to start charging. </p>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="ad54912c48ac30fc66796b2aeca58cea7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad54912c48ac30fc66796b2aeca58cea7">&#9670;&nbsp;</a></span>stopBalance()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef stopBalance </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Stops all cells balancing by sending command to AMS boards. </p>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<a id="a5cf6c235603af078c2dc841ae579f3b5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5cf6c235603af078c2dc841ae579f3b5">&#9670;&nbsp;</a></span>stopCharging()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HAL_StatusTypeDef stopCharging </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sends a command to the charger to stop charging. </p>
<dl class="section return"><dt>Returns</dt><dd>HAL_StatusTypeDef </dd></dl>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a4bb357024aa0bb23dcfba57009d3f836"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4bb357024aa0bb23dcfba57009d3f836">&#9670;&nbsp;</a></span>isTempCellWorking</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool isTempCellWorking[TEMPCELL_COUNT]</td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Initial value:</b><div class="fragment"><div class="line">= {</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">true , true , true , <span class="keyword">false</span>, true , true , true , true , true , true , <span class="keyword">false</span>, <span class="keyword">false</span>,</div>
<div class="line"> </div>
<div class="line">true , true , true , <span class="keyword">false</span>, true , true , true , true , true , true , <span class="keyword">false</span>, <span class="keyword">false</span>,</div>
<div class="line"> </div>
<div class="line">true , true , <span class="keyword">false</span>, <span class="keyword">false</span>, true , <span class="keyword">false</span>, <span class="keyword">false</span>, true , true , <span class="keyword">false</span>, true , true ,</div>
<div class="line"> </div>
<div class="line"><span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</div>
<div class="line"> </div>
<div class="line"><span class="keyword">false</span>, true , true , <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, true , true , true , <span class="keyword">false</span>, <span class="keyword">false</span>,</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">}</div>
</div><!-- fragment --><p>Since some thermistors don't give accurate readings (as of June 2020 not sure why, but maybe due to bad mechanical connections) this array specifies which temperature readings are working. The working readings are the only ones checked to ensure they are within safe limits and to determine min and max temperatures. </p>

</div>
</div>
<a id="a1e19984c8df58b545da1c8f8b5547acd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1e19984c8df58b545da1c8f8b5547acd">&#9670;&nbsp;</a></span>maxChargeVoltage</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float maxChargeVoltage = LIMIT_OVERVOLTAGE * VOLTAGECELL_COUNT</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Charging voltage limit to be sent to charger. Charging is actually stopped based on min cell SoC as specified by <a class="el" href="batteries_8c.html#a1c3f97f617827a946894da14b7e6e4d4">CHARGE_STOP_SOC</a> </p>

</div>
</div>
<a id="ab483cabe57068f7e0fd4bcaee6c1fb59"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab483cabe57068f7e0fd4bcaee6c1fb59">&#9670;&nbsp;</a></span>voltageToSOCLookup</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float voltageToSOCLookup[NUM_SOC_LOOKUP_VALS]</td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Initial value:</b><div class="fragment"><div class="line">= {</div>
<div class="line">   0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20,</div>
<div class="line">   21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40,</div>
<div class="line">   41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60,</div>
<div class="line">   61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80,</div>
<div class="line">   81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100</div>
<div class="line">}</div>
</div><!-- fragment --><p>Lookup table to convert cell voltage to cell state of charge. See BMU confluence page for more info </p>

</div>
</div>
<a id="a61bd11f0a0377192a9a1950e18664728"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a61bd11f0a0377192a9a1950e18664728">&#9670;&nbsp;</a></span>warningSentForCellTemp</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool warningSentForCellTemp[TEMPCELL_COUNT]</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Set to true if we've already sent a high temperature warning for this cell to stop repeated warnings being sent. Reset to false on init or when cell voltage increases above high temperature warning limit </p>

</div>
</div>
<a id="afeb7e3ce5be75e8a7d03ae9bbc3c2150"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afeb7e3ce5be75e8a7d03ae9bbc3c2150">&#9670;&nbsp;</a></span>warningSentForCellVoltage</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool warningSentForCellVoltage[VOLTAGECELL_COUNT]</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Set to true if we've already sent a low voltage warning for this cell to stop repeated warnings being sent. Reset to false on init or when cell voltage increases above low voltage warning limit </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
