\hypertarget{batteries_8c}{}\doxysection{/\+Users/\+Richard/\+Documents/\+Waterloo/\+W\+F\+E/\+Code.nosync/2018\+\_\+bmu-\/2/\+Src/batteries.c File Reference}
\label{batteries_8c}\index{/Users/Richard/Documents/Waterloo/WFE/Code.nosync/2018\_bmu-\/2/Src/batteries.c@{/Users/Richard/Documents/Waterloo/WFE/Code.nosync/2018\_bmu-\/2/Src/batteries.c}}


Battery Monitoring, Charging, HV Bus Sense, I\+MD monitor.  


{\ttfamily \#include \char`\"{}batteries.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}Free\+R\+T\+O\+S.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}cmsis\+\_\+os.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}task.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}control\+State\+Machine.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}math.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}B\+M\+U\+\_\+can.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}B\+M\+U\+\_\+dtc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}board\+Types.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}watchdog.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}can\+Receive.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}charger\+Control.\+h\char`\"{}}\newline
\doxysubsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\mbox{\Hypertarget{batteries_8c_aadfade60a9946687e6a1a4a24b70fb4c}\label{batteries_8c_aadfade60a9946687e6a1a4a24b70fb4c}} 
\#define {\bfseries E\+N\+A\+B\+L\+E\+\_\+\+I\+MD}
\item 
\mbox{\Hypertarget{batteries_8c_aa31c40ba22e94296395602249e2b25eb}\label{batteries_8c_aa31c40ba22e94296395602249e2b25eb}} 
\#define {\bfseries E\+N\+A\+B\+L\+E\+\_\+\+H\+V\+\_\+\+M\+E\+A\+S\+U\+RE}
\item 
\mbox{\Hypertarget{batteries_8c_a2828019bbccc5743ed8275fc9a4fe1a3}\label{batteries_8c_a2828019bbccc5743ed8275fc9a4fe1a3}} 
\#define {\bfseries E\+N\+A\+B\+L\+E\+\_\+\+A\+MS}
\item 
\mbox{\Hypertarget{batteries_8c_a9fea424f5555dcbb0ba5c1e4871e855f}\label{batteries_8c_a9fea424f5555dcbb0ba5c1e4871e855f}} 
\#define {\bfseries E\+N\+A\+B\+L\+E\+\_\+\+C\+H\+A\+R\+G\+ER}
\item 
\mbox{\Hypertarget{batteries_8c_a8ba2127550d368f846692fdcf3ca095f}\label{batteries_8c_a8ba2127550d368f846692fdcf3ca095f}} 
\#define {\bfseries E\+N\+A\+B\+L\+E\+\_\+\+B\+A\+L\+A\+N\+CE}
\item 
\mbox{\Hypertarget{batteries_8c_a62b353ffb0e0f9735e0c6a32712e85b2}\label{batteries_8c_a62b353ffb0e0f9735e0c6a32712e85b2}} 
\#define {\bfseries B\+A\+T\+T\+E\+R\+Y\+\_\+\+T\+A\+S\+K\+\_\+\+P\+E\+R\+I\+O\+D\+\_\+\+MS}~100
\item 
\mbox{\Hypertarget{batteries_8c_a6d5ce7bfac0354a10a78a45aa0ebaacf}\label{batteries_8c_a6d5ce7bfac0354a10a78a45aa0ebaacf}} 
\#define {\bfseries B\+A\+T\+T\+E\+R\+Y\+\_\+\+C\+H\+A\+R\+G\+E\+\_\+\+T\+A\+S\+K\+\_\+\+P\+E\+R\+I\+O\+D\+\_\+\+MS}~2000
\item 
\mbox{\Hypertarget{batteries_8c_aeb85d8df3b9f6218cb677ccd44760cd4}\label{batteries_8c_aeb85d8df3b9f6218cb677ccd44760cd4}} 
\#define {\bfseries B\+A\+T\+T\+E\+R\+Y\+\_\+\+T\+A\+S\+K\+\_\+\+ID}~2
\item 
\mbox{\Hypertarget{batteries_8c_aa4b530cc846953d732a4582912f703d2}\label{batteries_8c_aa4b530cc846953d732a4582912f703d2}} 
\#define {\bfseries L\+I\+M\+I\+T\+\_\+\+O\+V\+E\+R\+V\+O\+L\+T\+A\+GE}~4.\+2F
\item 
\mbox{\Hypertarget{batteries_8c_a582698c135482c98c6911f0bdbf8d1ad}\label{batteries_8c_a582698c135482c98c6911f0bdbf8d1ad}} 
\#define {\bfseries L\+I\+M\+I\+T\+\_\+\+H\+I\+G\+H\+V\+O\+L\+T\+A\+GE}~4.\+2F
\item 
\mbox{\Hypertarget{batteries_8c_a2f9e0b5026ad096458f1bdcc559cfab7}\label{batteries_8c_a2f9e0b5026ad096458f1bdcc559cfab7}} 
\#define {\bfseries L\+I\+M\+I\+T\+\_\+\+L\+O\+W\+V\+O\+L\+T\+A\+GE}~3.\+0F
\item 
\mbox{\Hypertarget{batteries_8c_a6136cb9cd8ceabce6e9fdda8cb05c3bd}\label{batteries_8c_a6136cb9cd8ceabce6e9fdda8cb05c3bd}} 
\#define {\bfseries L\+I\+M\+I\+T\+\_\+\+U\+N\+D\+E\+R\+V\+O\+L\+T\+A\+GE}~3.\+0F
\item 
\mbox{\Hypertarget{batteries_8c_ab4cdc344852b65658b9d24c04473f26d}\label{batteries_8c_ab4cdc344852b65658b9d24c04473f26d}} 
\#define {\bfseries L\+I\+M\+I\+T\+\_\+\+L\+O\+W\+V\+O\+L\+T\+A\+G\+E\+\_\+\+W\+A\+R\+N\+I\+NG}~3.\+2F
\item 
\mbox{\Hypertarget{batteries_8c_a374bf63b81c93c7d9e76601f46b9f184}\label{batteries_8c_a374bf63b81c93c7d9e76601f46b9f184}} 
\#define {\bfseries C\+E\+L\+L\+\_\+\+T\+I\+M\+E\+\_\+\+T\+O\+\_\+\+F\+A\+I\+L\+U\+R\+E\+\_\+\+A\+L\+L\+O\+W\+A\+B\+LE}~(6.\+0)
\item 
\mbox{\Hypertarget{batteries_8c_ace79b123d44fbbb7d6b78e0e9fa98930}\label{batteries_8c_ace79b123d44fbbb7d6b78e0e9fa98930}} 
\#define {\bfseries C\+E\+L\+L\+\_\+\+D\+CR}~(0.\+01)
\item 
\mbox{\Hypertarget{batteries_8c_a16227ae24d95ceebf83b650ccdb0dfa4}\label{batteries_8c_a16227ae24d95ceebf83b650ccdb0dfa4}} 
\#define {\bfseries C\+E\+L\+L\+\_\+\+H\+E\+A\+T\+\_\+\+C\+A\+P\+A\+C\+I\+TY}~(1034.\+2)
\item 
\mbox{\Hypertarget{batteries_8c_a8fec377e4c098c8c294afce44c6c69d0}\label{batteries_8c_a8fec377e4c098c8c294afce44c6c69d0}} 
\#define {\bfseries C\+E\+L\+L\+\_\+\+M\+A\+SS}~(0.\+496)
\item 
\mbox{\Hypertarget{batteries_8c_aa72653c5b21b8d21a14cdba38e71c6eb}\label{batteries_8c_aa72653c5b21b8d21a14cdba38e71c6eb}} 
\#define {\bfseries C\+E\+L\+L\+\_\+\+O\+V\+E\+R\+T\+E\+MP}~(C\+E\+L\+L\+\_\+\+M\+A\+X\+\_\+\+T\+E\+M\+P\+\_\+C)
\item 
\mbox{\Hypertarget{batteries_8c_a8531f997baa2780a823499e18bdebec3}\label{batteries_8c_a8531f997baa2780a823499e18bdebec3}} 
\#define {\bfseries C\+E\+L\+L\+\_\+\+O\+V\+E\+R\+T\+E\+M\+P\+\_\+\+W\+A\+R\+N\+I\+NG}~(C\+E\+L\+L\+\_\+\+M\+A\+X\+\_\+\+T\+E\+M\+P\+\_\+C -\/ 10)
\item 
\mbox{\Hypertarget{batteries_8c_ad5819e811f281911c5854f40cf58960f}\label{batteries_8c_ad5819e811f281911c5854f40cf58960f}} 
\#define \mbox{\hyperlink{batteries_8c_ad5819e811f281911c5854f40cf58960f}{B\+A\+L\+A\+N\+C\+E\+\_\+\+S\+T\+A\+R\+T\+\_\+\+V\+O\+L\+T\+A\+GE}}~(3.\+5F)
\begin{DoxyCompactList}\small\item\em Block balancing below this cell voltage. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{batteries_8c_ae7647190367a5af57c404c325ede1e56}\label{batteries_8c_ae7647190367a5af57c404c325ede1e56}} 
\#define \mbox{\hyperlink{batteries_8c_ae7647190367a5af57c404c325ede1e56}{C\+E\+L\+L\+\_\+\+R\+E\+L\+A\+X\+A\+T\+I\+O\+N\+\_\+\+T\+I\+M\+E\+\_\+\+MS}}~(1000)
\begin{DoxyCompactList}\small\item\em Pause balancing for this length when reading cell voltages to get good readings. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{batteries_8c_a1c3f97f617827a946894da14b7e6e4d4}\label{batteries_8c_a1c3f97f617827a946894da14b7e6e4d4}} 
\#define \mbox{\hyperlink{batteries_8c_a1c3f97f617827a946894da14b7e6e4d4}{C\+H\+A\+R\+G\+E\+\_\+\+S\+T\+O\+P\+\_\+\+S\+OC}}~(98.\+0)
\begin{DoxyCompactList}\small\item\em SoC to stop charging at (of the cell with lowest SoC) \end{DoxyCompactList}\item 
\#define \mbox{\hyperlink{batteries_8c_a3840db84d2eaac3f4fe59941e21ff410}{C\+H\+A\+R\+G\+E\+\_\+\+C\+A\+R\+T\+\_\+\+H\+E\+A\+R\+T\+B\+E\+A\+T\+\_\+\+M\+A\+X\+\_\+\+P\+E\+R\+I\+OD}}~(1000)
\item 
\mbox{\Hypertarget{batteries_8c_a68aaf77b085834ea0c03a6ab2e2910f6}\label{batteries_8c_a68aaf77b085834ea0c03a6ab2e2910f6}} 
\#define \mbox{\hyperlink{batteries_8c_a68aaf77b085834ea0c03a6ab2e2910f6}{C\+H\+A\+R\+G\+E\+\_\+\+D\+E\+F\+A\+U\+L\+T\+\_\+\+M\+A\+X\+\_\+\+C\+U\+R\+R\+E\+NT}}~5
\begin{DoxyCompactList}\small\item\em Default charging current limit (Amps) \end{DoxyCompactList}\item 
\#define \mbox{\hyperlink{batteries_8c_aaa9233fe54ffd66274a5dd46390b36e5}{B\+A\+L\+A\+N\+C\+E\+\_\+\+R\+E\+C\+H\+E\+C\+K\+\_\+\+P\+E\+R\+I\+O\+D\+\_\+\+MS}}~(3000)
\item 
\mbox{\Hypertarget{batteries_8c_a4ec6365ec832a79d6e0633c4f49b3b55}\label{batteries_8c_a4ec6365ec832a79d6e0633c4f49b3b55}} 
\#define {\bfseries N\+U\+M\+\_\+\+S\+O\+C\+\_\+\+L\+O\+O\+K\+U\+P\+\_\+\+V\+A\+LS}~101
\item 
\mbox{\Hypertarget{batteries_8c_affc1e4ab7cea9fe57082528ac006cc50}\label{batteries_8c_affc1e4ab7cea9fe57082528ac006cc50}} 
\#define {\bfseries H\+V\+\_\+\+M\+E\+A\+S\+U\+R\+E\+\_\+\+T\+A\+S\+K\+\_\+\+P\+E\+R\+I\+O\+D\+\_\+\+MS}~1
\item 
\mbox{\Hypertarget{batteries_8c_ab4536de5261b4bd382b10d69f857dbe3}\label{batteries_8c_ab4536de5261b4bd382b10d69f857dbe3}} 
\#define {\bfseries H\+V\+\_\+\+M\+E\+A\+S\+U\+R\+E\+\_\+\+T\+A\+S\+K\+\_\+\+ID}~4
\item 
\mbox{\Hypertarget{batteries_8c_a0fc9cbf2e0173158d4cd0536059a272f}\label{batteries_8c_a0fc9cbf2e0173158d4cd0536059a272f}} 
\#define {\bfseries S\+T\+A\+T\+E\+\_\+\+B\+U\+S\+\_\+\+H\+V\+\_\+\+C\+A\+N\+\_\+\+S\+E\+N\+D\+\_\+\+P\+E\+R\+I\+O\+D\+\_\+\+MS}~500
\item 
\mbox{\Hypertarget{batteries_8c_a918bb56d5d536252807bb42ab03b3728}\label{batteries_8c_a918bb56d5d536252807bb42ab03b3728}} 
\#define {\bfseries I\+M\+D\+\_\+\+T\+A\+S\+K\+\_\+\+P\+E\+R\+I\+O\+D\+\_\+\+MS}~1000
\item 
\mbox{\Hypertarget{batteries_8c_a5a2f513c66eeae901bf7536957487e74}\label{batteries_8c_a5a2f513c66eeae901bf7536957487e74}} 
\#define {\bfseries I\+M\+D\+\_\+\+T\+A\+S\+K\+\_\+\+ID}~5
\item 
\mbox{\Hypertarget{batteries_8c_a1951643638039378eccc6e0ffef18a22}\label{batteries_8c_a1951643638039378eccc6e0ffef18a22}} 
\#define \mbox{\hyperlink{batteries_8c_a1951643638039378eccc6e0ffef18a22}{I\+B\+U\+S\+\_\+\+F\+I\+L\+T\+E\+R\+\_\+\+A\+L\+P\+HA}}~0.\+24
\begin{DoxyCompactList}\small\item\em Filter constant for HV Bus current low pass filter Designed around 1 ms sample period and 50 Hz cuttoff. See the wikipedia page for the calculation\+: \href{https://en.wikipedia.org/wiki/Low-pass_filter\#Simple_infinite_impulse_response_filter}{\texttt{ https\+://en.\+wikipedia.\+org/wiki/\+Low-\/pass\+\_\+filter\#\+Simple\+\_\+infinite\+\_\+impulse\+\_\+response\+\_\+filter}}. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{batteries_8c_ad4389fd57fbbb4a3c70d7a626285eaa0}\label{batteries_8c_ad4389fd57fbbb4a3c70d7a626285eaa0}} 
\#define \mbox{\hyperlink{batteries_8c_ad4389fd57fbbb4a3c70d7a626285eaa0}{M\+A\+X\+\_\+\+E\+R\+R\+O\+R\+\_\+\+C\+O\+U\+NT}}~3
\begin{DoxyCompactList}\small\item\em Maximum number of errors battery task can encounter before reporting error. \end{DoxyCompactList}\item 
\#define \mbox{\hyperlink{batteries_8c_a9b3fe58b53cbf8d5fbc53709ed5a278b}{C\+E\+L\+L\+\_\+\+V\+O\+L\+T\+A\+G\+E\+\_\+\+F\+I\+L\+T\+E\+R\+\_\+\+A\+L\+P\+HA}}~0.\+18
\item 
\mbox{\Hypertarget{batteries_8c_ab75dbcd7e0a59fc3d1fc3715de87544a}\label{batteries_8c_ab75dbcd7e0a59fc3d1fc3715de87544a}} 
\#define \mbox{\hyperlink{batteries_8c_ab75dbcd7e0a59fc3d1fc3715de87544a}{C\+A\+N\+\_\+\+C\+E\+L\+L\+\_\+\+S\+E\+N\+D\+\_\+\+P\+E\+R\+I\+O\+D\+\_\+\+MS}}~40
\begin{DoxyCompactList}\small\item\em The period to send cell voltage and temperature C\+AN messages. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsection*{Typedefs}
\begin{DoxyCompactItemize}
\item 
typedef enum \mbox{\hyperlink{batteries_8c_a2f80b01711da374b25803fa818de09b1}{Charge\+Return}} \mbox{\hyperlink{batteries_8c_a57d972b2a0b68887bd7afab4c1d2553f}{Charge\+Return}}
\end{DoxyCompactItemize}
\doxysubsection*{Enumerations}
\begin{DoxyCompactItemize}
\item 
enum \mbox{\hyperlink{batteries_8c_a2f80b01711da374b25803fa818de09b1}{Charge\+Return}} \{ \mbox{\hyperlink{batteries_8c_a2f80b01711da374b25803fa818de09b1a0abf13e2a7d6435eb5b31d33abeadad7}{C\+H\+A\+R\+G\+E\+\_\+\+D\+O\+NE}}, 
\mbox{\hyperlink{batteries_8c_a2f80b01711da374b25803fa818de09b1a3db9c119e634b77566daafdde61b29f1}{C\+H\+A\+R\+G\+E\+\_\+\+S\+T\+O\+P\+P\+ED}}, 
\mbox{\hyperlink{batteries_8c_a2f80b01711da374b25803fa818de09b1ad0605183af862ee76169e8b41c7fd927}{C\+H\+A\+R\+G\+E\+\_\+\+E\+R\+R\+OR}}
 \}
\end{DoxyCompactItemize}
\doxysubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
float \mbox{\hyperlink{batteries_8c_a1300d8fea84c20d3945380460f61f81d}{filter\+I\+Bus}} (float I\+Bus)
\begin{DoxyCompactList}\small\item\em Low pass filters the HV Bus current measurement. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{batteries_8c_a951b2aac55838c4b1abd243f38e2ca47}\label{batteries_8c_a951b2aac55838c4b1abd243f38e2ca47}} 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a951b2aac55838c4b1abd243f38e2ca47}{init\+Bus\+Voltages\+And\+Current\+Queues}} ()
\begin{DoxyCompactList}\small\item\em Creates queues for HV Bus measurements Queue overwrite, Queue peek, and queue size of 1 is used to ensure only the most recent data is in the queue and read from the queue. Queues use Amps and Volts for units. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a37d4140213dc1708776032fc935e0b39}{publish\+Bus\+Voltages\+And\+Current}} (float $\ast$p\+I\+Bus, float $\ast$p\+V\+Bus, float $\ast$p\+V\+Batt)
\begin{DoxyCompactList}\small\item\em Publishes the most recent HV Bus measurements to queues for other tasks to read from Queue overwrite, Queue peek, and queue size of 1 is used to ensure only the most recent data is in the queue and read from the queue. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a4d72951e5a03e396bb864b5c45bda0f0}{read\+Bus\+Voltages\+And\+Currents}} (float $\ast$I\+Bus, float $\ast$V\+Bus, float $\ast$V\+Batt)
\begin{DoxyCompactList}\small\item\em Measures HV voltages and currents using the HV A\+DC. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a0ee7fbdeb8e2e8413b4fc77ba59223d5}{get\+I\+Bus}} (float $\ast$I\+Bus)
\begin{DoxyCompactList}\small\item\em Get the most recent bus current reading. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_aff30116cb629c2efdad61c2ccaec0c36}{get\+V\+Batt}} (float $\ast$V\+Batt)
\begin{DoxyCompactList}\small\item\em Get the most recent battery voltage reading (from the HV A\+DC). Note\+: this is only equal to the battery voltage when both contactors are closed. to get the battery voltage in all times, use \mbox{\hyperlink{batteries_8c_ab07aef73f633627b5a1a78e40f15961f}{get\+Pack\+Voltage}}. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a6fbf3bf910348af26a580fc418f89f5e}{get\+V\+Bus}} (float $\ast$V\+Bus)
\begin{DoxyCompactList}\small\item\em Get the most recent HV Bus voltage reading (from the HV A\+DC) \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a6e1bc0d2209bd309c4db0a06009a339a}{cli\+Set\+V\+Batt}} (float V\+Batt)
\begin{DoxyCompactList}\small\item\em For nucleo testing, allows setting a dummy value for the V\+Batt reading. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a2ab7e555695e672e38894f394a31a3ef}{cli\+Set\+V\+Bus}} (float V\+Bus)
\begin{DoxyCompactList}\small\item\em For nucleo testing, allows setting a dummy value for the V\+Bus reading. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a19d5fb02c3547746d76a121bf9f10807}{cli\+Set\+I\+Bus}} (float I\+Bus)
\begin{DoxyCompactList}\small\item\em For nucleo testing, allows setting a dummy value for the I\+Bus reading. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{batteries_8c_a1ef8191389452a8f21cb2d02b20cba29}{H\+V\+Measure\+Task}} (void $\ast$pv\+Paramaters)
\item 
\mbox{\Hypertarget{batteries_8c_a1f0375c4fc87fa9cfd8fbc1c5fcd33c9}\label{batteries_8c_a1f0375c4fc87fa9cfd8fbc1c5fcd33c9}} 
void \mbox{\hyperlink{batteries_8c_a1f0375c4fc87fa9cfd8fbc1c5fcd33c9}{imd\+Task}} (void $\ast$pv\+Paramaters)
\begin{DoxyCompactList}\small\item\em Monitors the Insulation Monitoring Device (I\+MD). Raises error if I\+MD reports fault. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a36a3c81e474331b59839cb2f565c7704}{read\+Cell\+Voltages\+And\+Temps}} ()
\begin{DoxyCompactList}\small\item\em Reads the cell voltages and temperatures from the A\+MS boards. The battery temperature and cell voltages are stored in the global arrays which are also used for sending them over C\+AN. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{batteries_8c_a34364371025450fc6bc3f0d86df0e5ca}\label{batteries_8c_a34364371025450fc6bc3f0d86df0e5ca}} 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a34364371025450fc6bc3f0d86df0e5ca}{init\+Voltage\+And\+Temp\+Arrays}} ()
\begin{DoxyCompactList}\small\item\em This functions sets all cell voltages and temps to known values. This is necessary for testing on Nucleo so it doesn\textquotesingle{}t immediately error before the user can manually set the Voltages and Temperatures. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{batteries_8c_ad7b6a3fe5ae01ef7695d9c36da0f832b}\label{batteries_8c_ad7b6a3fe5ae01ef7695d9c36da0f832b}} 
void \mbox{\hyperlink{batteries_8c_ad7b6a3fe5ae01ef7695d9c36da0f832b}{Battery\+Task\+Error}} ()
\begin{DoxyCompactList}\small\item\em Called if an error with batteries is detected. Raises error and stops battery task execution (without tripping watchdog) \end{DoxyCompactList}\item 
bool \mbox{\hyperlink{batteries_8c_a796b02ffebbe6ba22dca62df11bcb05c}{bounded\+Continue}} ()
\begin{DoxyCompactList}\small\item\em Called by battery task it an error is encountered that is not immediately fatal. This causes the task to retry its readings/whatever else failed M\+A\+X\+\_\+\+E\+R\+R\+O\+R\+\_\+\+C\+O\+U\+NT times, then fail and send error event. T\+O\+DO\+: ensure this is max 500 ms to meet rules for cell reading times. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{batteries_8c_acd3cd9ec15fdceb68c5516f59552605c}\label{batteries_8c_acd3cd9ec15fdceb68c5516f59552605c}} 
void \mbox{\hyperlink{batteries_8c_acd3cd9ec15fdceb68c5516f59552605c}{E\+R\+R\+O\+R\+\_\+\+C\+O\+U\+N\+T\+E\+R\+\_\+\+S\+U\+C\+C\+E\+SS}} ()
\begin{DoxyCompactList}\small\item\em Call on a succesful run through main loop. Decrements error counter on succesful run through main loop. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{batteries_8c_ae1d79ed043eedc99cbc01f7c59ce369e}{filter\+Cell\+Voltages}} (float $\ast$cell\+Voltages, float $\ast$\mbox{\hyperlink{batteries_8c_afa99b901194e86a7784f6213f9420089}{cell\+Voltages\+Filtered}})
\begin{DoxyCompactList}\small\item\em This takes an array of the instantaneous cell volages, and filters them on an ongoing basis using the cell\+Voltages\+Filtered array. For check cell voltages, a filtered version of cell voltages is needed to eliminate noise due to bad contact with A\+MS boards. The hypothesis is that the pogo pins make bad contact with the ams boards when the motors spin, thus the need for filtering. This hasn\textquotesingle{}t been proven however, but the filtering fixed the errors we saw before (info up to date as of May 2020) NB\+: Filter voltages shouldn\textquotesingle{}t be sent over C\+AN, only used with error checking. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a7090234402b08bb512cf5db06702c9f0}{check\+Cell\+Voltages\+And\+Temps}} (float $\ast$max\+Voltage, float $\ast$min\+Voltage, float $\ast$max\+Temp, float $\ast$min\+Temp, float $\ast$pack\+Voltage)
\begin{DoxyCompactList}\small\item\em Checks cell voltages and temperatures to ensure they are within safe limits, as well as sending out warnings when the values get close to their limits and updating max/min voltages/temps and calculated pack voltage NB\+: This skips checking temperatures of cells specified as having faulty measurements in \mbox{\hyperlink{batteries_8c_a4bb357024aa0bb23dcfba57009d3f836}{is\+Temp\+Cell\+Working}} array. \end{DoxyCompactList}\item 
float \mbox{\hyperlink{batteries_8c_a6b2f1ad817d75d1c5c590814371b5062}{calculate\+State\+Of\+Power}} ()
\begin{DoxyCompactList}\small\item\em Calculates the state of power of the battery pack. T\+O\+DO\+: this calculation is from 2017, so should be updated for the 2020 pack. \end{DoxyCompactList}\item 
float \mbox{\hyperlink{batteries_8c_a7b0e95f68b412d5d5e9620ffbae8750d}{calculate\+State\+Of\+Charge}} ()
\begin{DoxyCompactList}\small\item\em Calculates the state of charge of the battery pack. This is a measure of how much capacity the pack has left on its current charge. Currently its implemented as a simple ratio of min cell voltage versus safe limits. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_aeb2f305c6977c16734384de553edfa73}{battery\+Start}} ()
\begin{DoxyCompactList}\small\item\em Initializes the battery task. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_afa698a16023626be583ce5082c76f5ec}{publish\+Pack\+Voltage}} (float pack\+Voltage)
\begin{DoxyCompactList}\small\item\em Publishes the current pack voltage value to the queue for other tasks to read from. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_ab07aef73f633627b5a1a78e40f15961f}{get\+Pack\+Voltage}} (float $\ast$pack\+Voltage)
\begin{DoxyCompactList}\small\item\em Gets the current pack voltage. This returns the pack voltage as calculated by summing all the cell voltages. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a92932081ca58208175ca6c4e0971f06d}{init\+Pack\+Voltage\+Queue}} ()
\begin{DoxyCompactList}\small\item\em Creates the pack voltage queue. Needs to be called before R\+T\+OS starts. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_aacf3b5ff9648b813208cb6f91b370fef}{set\+Max\+Charge\+Current}} (float max\+Current)
\begin{DoxyCompactList}\small\item\em Sets the maximum current for the charger. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a43ea41cc1c21bd36b3622076e20b596c}{start\+Charging}} ()
\begin{DoxyCompactList}\small\item\em Sends the maximum charge current and voltage to the charger and waits for the charger to start charging. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a533907b25f7b1dbb355151d336ed9ff6}{continue\+Charging}} ()
\begin{DoxyCompactList}\small\item\em Sends messages to the charger. The charger expects a message every second so this needs to be repeatedly called during charging. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a5cf6c235603af078c2dc841ae579f3b5}{stop\+Charging}} ()
\begin{DoxyCompactList}\small\item\em Sends a command to the charger to stop charging. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_ad54912c48ac30fc66796b2aeca58cea7}{stop\+Balance}} ()
\begin{DoxyCompactList}\small\item\em Stops all cells balancing by sending command to A\+MS boards. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_aa04706789e98d82797970064b10dd0c9}{pause\+Balance}} ()
\begin{DoxyCompactList}\small\item\em Stops all cells balancing, but stores which cells were balancing to allowing resuming of balance for cells that were balancing. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_a82969943d42e6067b966c64c61196dcd}{resume\+Balance}} ()
\begin{DoxyCompactList}\small\item\em Resumes balancing after call to \mbox{\hyperlink{batteries_8c_aa04706789e98d82797970064b10dd0c9}{pause\+Balance}}. \end{DoxyCompactList}\item 
H\+A\+L\+\_\+\+Status\+Type\+Def \mbox{\hyperlink{batteries_8c_aaacb3ffbd5367bbde01d4e8120fdbea0}{balance\+\_\+cell}} (int cell, bool set)
\begin{DoxyCompactList}\small\item\em Control the balance state of an individual cell. NB\+: this is inneficient if balancing multiple cells, as he entire balance config is sent to the A\+MS boards every time this is called. Instead, use the lower level batt\+\_\+balance\+\_\+cell/batt\+\_\+stop\+\_\+balance\+\_\+cell to change state for all cells, then call batt\+\_\+write\+\_\+config to send the new balance config. \end{DoxyCompactList}\item 
float \mbox{\hyperlink{batteries_8c_aed5d06c4a55e40673204ceacf2fde819}{map\+\_\+range\+\_\+float}} (float in, float low, float high, float low\+\_\+out, float high\+\_\+out)
\begin{DoxyCompactList}\small\item\em Maps a value from one range to another in a linear manner. \end{DoxyCompactList}\item 
float \mbox{\hyperlink{batteries_8c_a3d41850a2fe8400978c4f68163d726be}{get\+S\+O\+C\+From\+Voltage}} (float cell\+Voltage)
\begin{DoxyCompactList}\small\item\em Calculates the SoC of a cell from the cell\textquotesingle{}s voltage. \end{DoxyCompactList}\item 
\mbox{\hyperlink{batteries_8c_a2f80b01711da374b25803fa818de09b1}{Charge\+Return}} \mbox{\hyperlink{batteries_8c_a9144cd162ceec3e710baea6601149b43}{balance\+Charge}} ()
\begin{DoxyCompactList}\small\item\em Performs balance charging. For more info, see the B\+MU page on confluence. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{batteries_8c_a3364449b5cc8a93c89985f5d9fa2984b}{battery\+Task}} (void $\ast$pv\+Parameter)
\begin{DoxyCompactList}\small\item\em Task to monitor cell voltages and temperatures, as well as perform balance charging. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{batteries_8c_acd55a62448b408952283c28d12dd4c1d}{set\+Send\+Only\+One\+Cell}} (int cell\+Idx)
\begin{DoxyCompactList}\small\item\em Repeatedly send the cell voltage and temperature for a specific cell. This is instead of the normal behaviour which cycles through all the cells sending a message every \mbox{\hyperlink{batteries_8c_ab75dbcd7e0a59fc3d1fc3715de87544a}{C\+A\+N\+\_\+\+C\+E\+L\+L\+\_\+\+S\+E\+N\+D\+\_\+\+P\+E\+R\+I\+O\+D\+\_\+\+MS}}. Useful for battery testing to monitor a cell at higher frequency. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{batteries_8c_ade4720060f19979c4071eae3fb08ff92}\label{batteries_8c_ade4720060f19979c4071eae3fb08ff92}} 
void \mbox{\hyperlink{batteries_8c_ade4720060f19979c4071eae3fb08ff92}{clear\+Send\+Only\+One\+Cell}} ()
\begin{DoxyCompactList}\small\item\em Stop sending only one cell repeatedly, and go back to sending all cells over C\+AN. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{batteries_8c_a445bbbf2332f3c63a4bfcddf4b78ff43}{can\+Send\+Cell\+Task}} (void $\ast$pv\+Parameters)
\begin{DoxyCompactList}\small\item\em Sends the cell voltages and temperatures over C\+AN. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\mbox{\Hypertarget{batteries_8c_aa95731d4ff40893bc5d4c80cc0fa055f}\label{batteries_8c_aa95731d4ff40893bc5d4c80cc0fa055f}} 
os\+Thread\+Id {\bfseries Battery\+Task\+Handle}
\item 
\mbox{\Hypertarget{batteries_8c_a098ac94ec41c0b74569366cf7660c680}\label{batteries_8c_a098ac94ec41c0b74569366cf7660c680}} 
float \mbox{\hyperlink{batteries_8c_a098ac94ec41c0b74569366cf7660c680}{max\+Charge\+Current}} = \mbox{\hyperlink{batteries_8c_a68aaf77b085834ea0c03a6ab2e2910f6}{C\+H\+A\+R\+G\+E\+\_\+\+D\+E\+F\+A\+U\+L\+T\+\_\+\+M\+A\+X\+\_\+\+C\+U\+R\+R\+E\+NT}}
\begin{DoxyCompactList}\small\item\em Charging current limit. \end{DoxyCompactList}\item 
float \mbox{\hyperlink{batteries_8c_a1e19984c8df58b545da1c8f8b5547acd}{max\+Charge\+Voltage}} = L\+I\+M\+I\+T\+\_\+\+O\+V\+E\+R\+V\+O\+L\+T\+A\+GE $\ast$ V\+O\+L\+T\+A\+G\+E\+C\+E\+L\+L\+\_\+\+C\+O\+U\+NT
\item 
bool \mbox{\hyperlink{batteries_8c_afeb7e3ce5be75e8a7d03ae9bbc3c2150}{warning\+Sent\+For\+Cell\+Voltage}} \mbox{[}V\+O\+L\+T\+A\+G\+E\+C\+E\+L\+L\+\_\+\+C\+O\+U\+NT\mbox{]}
\item 
bool \mbox{\hyperlink{batteries_8c_a61bd11f0a0377192a9a1950e18664728}{warning\+Sent\+For\+Cell\+Temp}} \mbox{[}T\+E\+M\+P\+C\+E\+L\+L\+\_\+\+C\+O\+U\+NT\mbox{]}
\item 
bool \mbox{\hyperlink{batteries_8c_a4bb357024aa0bb23dcfba57009d3f836}{is\+Temp\+Cell\+Working}} \mbox{[}T\+E\+M\+P\+C\+E\+L\+L\+\_\+\+C\+O\+U\+NT\mbox{]}
\item 
float \mbox{\hyperlink{batteries_8c_ab483cabe57068f7e0fd4bcaee6c1fb59}{voltage\+To\+S\+O\+C\+Lookup}} \mbox{[}N\+U\+M\+\_\+\+S\+O\+C\+\_\+\+L\+O\+O\+K\+U\+P\+\_\+\+V\+A\+LS\mbox{]}
\item 
\mbox{\Hypertarget{batteries_8c_a141159dacb84bda6d1ce0a156c258177}\label{batteries_8c_a141159dacb84bda6d1ce0a156c258177}} 
Queue\+Handle\+\_\+t \mbox{\hyperlink{batteries_8c_a141159dacb84bda6d1ce0a156c258177}{I\+Bus\+Queue}}
\begin{DoxyCompactList}\small\item\em Queue holding most recent bus current measurement. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{batteries_8c_abafdcf601bccb3238fcb8534b517d130}\label{batteries_8c_abafdcf601bccb3238fcb8534b517d130}} 
Queue\+Handle\+\_\+t \mbox{\hyperlink{batteries_8c_abafdcf601bccb3238fcb8534b517d130}{V\+Bus\+Queue}}
\begin{DoxyCompactList}\small\item\em Queue holding most recent bus volage measurement. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{batteries_8c_ad64f368c4f439a41338c59c0c4b685e2}\label{batteries_8c_ad64f368c4f439a41338c59c0c4b685e2}} 
Queue\+Handle\+\_\+t \mbox{\hyperlink{batteries_8c_ad64f368c4f439a41338c59c0c4b685e2}{V\+Batt\+Queue}}
\begin{DoxyCompactList}\small\item\em Queue holding most recent battery voltage measurement. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{batteries_8c_a17c95138c88cf1a7a64a0dd006730b6c}\label{batteries_8c_a17c95138c88cf1a7a64a0dd006730b6c}} 
Queue\+Handle\+\_\+t \mbox{\hyperlink{batteries_8c_a17c95138c88cf1a7a64a0dd006730b6c}{Pack\+Voltage\+Queue}}
\begin{DoxyCompactList}\small\item\em Queue holding most recent battery voltage (calculated from sum of cell voltages) measurement. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{batteries_8c_afa99b901194e86a7784f6213f9420089}\label{batteries_8c_afa99b901194e86a7784f6213f9420089}} 
float \mbox{\hyperlink{batteries_8c_afa99b901194e86a7784f6213f9420089}{cell\+Voltages\+Filtered}} \mbox{[}V\+O\+L\+T\+A\+G\+E\+C\+E\+L\+L\+\_\+\+C\+O\+U\+NT\mbox{]}
\begin{DoxyCompactList}\small\item\em Array is used to store the filtered voltages. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{batteries_8c_a58c53a03f6ed59b66477d9ff778a7ec1}\label{batteries_8c_a58c53a03f6ed59b66477d9ff778a7ec1}} 
bool \mbox{\hyperlink{batteries_8c_a58c53a03f6ed59b66477d9ff778a7ec1}{is\+Cell\+Balancing}} \mbox{[}V\+O\+L\+T\+A\+G\+E\+C\+E\+L\+L\+\_\+\+C\+O\+U\+NT\mbox{]} = \{0\}
\begin{DoxyCompactList}\small\item\em Array to store if a cell is balancing. \end{DoxyCompactList}\item 
\mbox{\Hypertarget{batteries_8c_a08165bcd985456a8bb4f39d29b0132d8}\label{batteries_8c_a08165bcd985456a8bb4f39d29b0132d8}} 
bool {\bfseries send\+One\+Cell\+Volt\+And\+Temp} = false
\item 
\mbox{\Hypertarget{batteries_8c_a45eac5b187ae199e0de1fa376e2024b3}\label{batteries_8c_a45eac5b187ae199e0de1fa376e2024b3}} 
int {\bfseries cell\+To\+Send}
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Battery Monitoring, Charging, HV Bus Sense, I\+MD monitor. 

\begin{DoxyAuthor}{Author}
Richard Matthews
\end{DoxyAuthor}
This file contains a number of tasks and related functions\+:
\begin{DoxyItemize}
\item Battery Monitoring and Charging (battery\+Task)\+: Monitors the voltage and temperature of all cells by communicating with the A\+MS boards, performs balance charging and communicates with the charger over C\+AN
\item HV Bus Sense (H\+V\+Measure\+Task)\+: Measures the voltage and current on the HV Bus as well as the HV battery pack voltage
\item I\+MD Monitoring (imd\+Task)\+: Measures the signals from the insulation monitoring device (I\+MD) to check for insulation faults
\item can\+Send\+Cell\+Task\+: Sends the cell voltage and temperatures over C\+AN using the multiplexed C\+AN messages 
\end{DoxyItemize}

\doxysubsection{Macro Definition Documentation}
\mbox{\Hypertarget{batteries_8c_aaa9233fe54ffd66274a5dd46390b36e5}\label{batteries_8c_aaa9233fe54ffd66274a5dd46390b36e5}} 
\index{batteries.c@{batteries.c}!BALANCE\_RECHECK\_PERIOD\_MS@{BALANCE\_RECHECK\_PERIOD\_MS}}
\index{BALANCE\_RECHECK\_PERIOD\_MS@{BALANCE\_RECHECK\_PERIOD\_MS}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{BALANCE\_RECHECK\_PERIOD\_MS}{BALANCE\_RECHECK\_PERIOD\_MS}}
{\footnotesize\ttfamily \#define B\+A\+L\+A\+N\+C\+E\+\_\+\+R\+E\+C\+H\+E\+C\+K\+\_\+\+P\+E\+R\+I\+O\+D\+\_\+\+MS~(3000)}

Period at which cell So\+Cs are checked to determine which cells to balance. This should be long enough so cells aren\textquotesingle{}t constantly being toggled between balance and not \mbox{\Hypertarget{batteries_8c_a9b3fe58b53cbf8d5fbc53709ed5a278b}\label{batteries_8c_a9b3fe58b53cbf8d5fbc53709ed5a278b}} 
\index{batteries.c@{batteries.c}!CELL\_VOLTAGE\_FILTER\_ALPHA@{CELL\_VOLTAGE\_FILTER\_ALPHA}}
\index{CELL\_VOLTAGE\_FILTER\_ALPHA@{CELL\_VOLTAGE\_FILTER\_ALPHA}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{CELL\_VOLTAGE\_FILTER\_ALPHA}{CELL\_VOLTAGE\_FILTER\_ALPHA}}
{\footnotesize\ttfamily \#define C\+E\+L\+L\+\_\+\+V\+O\+L\+T\+A\+G\+E\+\_\+\+F\+I\+L\+T\+E\+R\+\_\+\+A\+L\+P\+HA~0.\+18}

Alpha value for cell voltage filter For a 10-\/90 rise time of 1 sec, set the bandwidth to 0.\+35 Hz See\+: \href{https://www.edn.com/electronics-blogs/bogatin-s-rules-of-thumb/4424573/Rule-of-Thumb&ndash;1&ndash;The-bandwidth-of-a-signal-from-its-rise-time}{\texttt{ https\+://www.\+edn.\+com/electronics-\/blogs/bogatin-\/s-\/rules-\/of-\/thumb/4424573/\+Rule-\/of-\/\+Thumb--1--\+The-\/bandwidth-\/of-\/a-\/signal-\/from-\/its-\/rise-\/time}} This cuttoff, with a sampling frequency of 100 ms gives an alpha of 0.\+18 See the wikipedia page for the alpha calculation\+: \href{https://en.wikipedia.org/wiki/Low-pass_filter\#Simple_infinite_impulse_response_filter}{\texttt{ https\+://en.\+wikipedia.\+org/wiki/\+Low-\/pass\+\_\+filter\#\+Simple\+\_\+infinite\+\_\+impulse\+\_\+response\+\_\+filter}} \mbox{\Hypertarget{batteries_8c_a3840db84d2eaac3f4fe59941e21ff410}\label{batteries_8c_a3840db84d2eaac3f4fe59941e21ff410}} 
\index{batteries.c@{batteries.c}!CHARGE\_CART\_HEARTBEAT\_MAX\_PERIOD@{CHARGE\_CART\_HEARTBEAT\_MAX\_PERIOD}}
\index{CHARGE\_CART\_HEARTBEAT\_MAX\_PERIOD@{CHARGE\_CART\_HEARTBEAT\_MAX\_PERIOD}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{CHARGE\_CART\_HEARTBEAT\_MAX\_PERIOD}{CHARGE\_CART\_HEARTBEAT\_MAX\_PERIOD}}
{\footnotesize\ttfamily \#define C\+H\+A\+R\+G\+E\+\_\+\+C\+A\+R\+T\+\_\+\+H\+E\+A\+R\+T\+B\+E\+A\+T\+\_\+\+M\+A\+X\+\_\+\+P\+E\+R\+I\+OD~(1000)}

If using charge cart heartbeat, this heartbeat timeout. NB\+: We are phasing out use of charge cart as a board with a microcontroller 

\doxysubsection{Typedef Documentation}
\mbox{\Hypertarget{batteries_8c_a57d972b2a0b68887bd7afab4c1d2553f}\label{batteries_8c_a57d972b2a0b68887bd7afab4c1d2553f}} 
\index{batteries.c@{batteries.c}!ChargeReturn@{ChargeReturn}}
\index{ChargeReturn@{ChargeReturn}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{ChargeReturn}{ChargeReturn}}
{\footnotesize\ttfamily typedef enum \mbox{\hyperlink{batteries_8c_a2f80b01711da374b25803fa818de09b1}{Charge\+Return}} \mbox{\hyperlink{batteries_8c_a2f80b01711da374b25803fa818de09b1}{Charge\+Return}}}

Return of balance charge function 

\doxysubsection{Enumeration Type Documentation}
\mbox{\Hypertarget{batteries_8c_a2f80b01711da374b25803fa818de09b1}\label{batteries_8c_a2f80b01711da374b25803fa818de09b1}} 
\index{batteries.c@{batteries.c}!ChargeReturn@{ChargeReturn}}
\index{ChargeReturn@{ChargeReturn}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{ChargeReturn}{ChargeReturn}}
{\footnotesize\ttfamily enum \mbox{\hyperlink{batteries_8c_a2f80b01711da374b25803fa818de09b1}{Charge\+Return}}}

Return of balance charge function \begin{DoxyEnumFields}{Enumerator}
\raisebox{\heightof{T}}[0pt][0pt]{\index{CHARGE\_DONE@{CHARGE\_DONE}!batteries.c@{batteries.c}}\index{batteries.c@{batteries.c}!CHARGE\_DONE@{CHARGE\_DONE}}}\mbox{\Hypertarget{batteries_8c_a2f80b01711da374b25803fa818de09b1a0abf13e2a7d6435eb5b31d33abeadad7}\label{batteries_8c_a2f80b01711da374b25803fa818de09b1a0abf13e2a7d6435eb5b31d33abeadad7}} 
C\+H\+A\+R\+G\+E\+\_\+\+D\+O\+NE&Charging finished, cells reached fully charged. \\
\hline

\raisebox{\heightof{T}}[0pt][0pt]{\index{CHARGE\_STOPPED@{CHARGE\_STOPPED}!batteries.c@{batteries.c}}\index{batteries.c@{batteries.c}!CHARGE\_STOPPED@{CHARGE\_STOPPED}}}\mbox{\Hypertarget{batteries_8c_a2f80b01711da374b25803fa818de09b1a3db9c119e634b77566daafdde61b29f1}\label{batteries_8c_a2f80b01711da374b25803fa818de09b1a3db9c119e634b77566daafdde61b29f1}} 
C\+H\+A\+R\+G\+E\+\_\+\+S\+T\+O\+P\+P\+ED&Charging was stopped as requested, cells not fully charged. \\
\hline

\raisebox{\heightof{T}}[0pt][0pt]{\index{CHARGE\_ERROR@{CHARGE\_ERROR}!batteries.c@{batteries.c}}\index{batteries.c@{batteries.c}!CHARGE\_ERROR@{CHARGE\_ERROR}}}\mbox{\Hypertarget{batteries_8c_a2f80b01711da374b25803fa818de09b1ad0605183af862ee76169e8b41c7fd927}\label{batteries_8c_a2f80b01711da374b25803fa818de09b1ad0605183af862ee76169e8b41c7fd927}} 
C\+H\+A\+R\+G\+E\+\_\+\+E\+R\+R\+OR&Error occured stopping charging, cells not fully charged. \\
\hline

\end{DoxyEnumFields}


\doxysubsection{Function Documentation}
\mbox{\Hypertarget{batteries_8c_aaacb3ffbd5367bbde01d4e8120fdbea0}\label{batteries_8c_aaacb3ffbd5367bbde01d4e8120fdbea0}} 
\index{batteries.c@{batteries.c}!balance\_cell@{balance\_cell}}
\index{balance\_cell@{balance\_cell}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{balance\_cell()}{balance\_cell()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def balance\+\_\+cell (\begin{DoxyParamCaption}\item[{int}]{cell,  }\item[{bool}]{set }\end{DoxyParamCaption})}



Control the balance state of an individual cell. NB\+: this is inneficient if balancing multiple cells, as he entire balance config is sent to the A\+MS boards every time this is called. Instead, use the lower level batt\+\_\+balance\+\_\+cell/batt\+\_\+stop\+\_\+balance\+\_\+cell to change state for all cells, then call batt\+\_\+write\+\_\+config to send the new balance config. 


\begin{DoxyParams}{Parameters}
{\em cell} & The cell to change the balance state of \\
\hline
{\em set} & True if should balance cell\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a9144cd162ceec3e710baea6601149b43}\label{batteries_8c_a9144cd162ceec3e710baea6601149b43}} 
\index{batteries.c@{batteries.c}!balanceCharge@{balanceCharge}}
\index{balanceCharge@{balanceCharge}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{balanceCharge()}{balanceCharge()}}
{\footnotesize\ttfamily \mbox{\hyperlink{batteries_8c_a2f80b01711da374b25803fa818de09b1}{Charge\+Return}} balance\+Charge (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Performs balance charging. For more info, see the B\+MU page on confluence. 

\begin{DoxyReturn}{Returns}
\mbox{\hyperlink{batteries_8c_a57d972b2a0b68887bd7afab4c1d2553f}{Charge\+Return}} 
\end{DoxyReturn}
!! Change the check in in bounded continue as well if you change this\mbox{\Hypertarget{batteries_8c_aeb2f305c6977c16734384de553edfa73}\label{batteries_8c_aeb2f305c6977c16734384de553edfa73}} 
\index{batteries.c@{batteries.c}!batteryStart@{batteryStart}}
\index{batteryStart@{batteryStart}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{batteryStart()}{batteryStart()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def battery\+Start (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Initializes the battery task. 

\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a3364449b5cc8a93c89985f5d9fa2984b}\label{batteries_8c_a3364449b5cc8a93c89985f5d9fa2984b}} 
\index{batteries.c@{batteries.c}!batteryTask@{batteryTask}}
\index{batteryTask@{batteryTask}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{batteryTask()}{batteryTask()}}
{\footnotesize\ttfamily void battery\+Task (\begin{DoxyParamCaption}\item[{void $\ast$}]{pv\+Parameter }\end{DoxyParamCaption})}



Task to monitor cell voltages and temperatures, as well as perform balance charging. 

!! Change the check in in bounded continue as well if you change this\mbox{\Hypertarget{batteries_8c_a796b02ffebbe6ba22dca62df11bcb05c}\label{batteries_8c_a796b02ffebbe6ba22dca62df11bcb05c}} 
\index{batteries.c@{batteries.c}!boundedContinue@{boundedContinue}}
\index{boundedContinue@{boundedContinue}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{boundedContinue()}{boundedContinue()}}
{\footnotesize\ttfamily bool bounded\+Continue (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Called by battery task it an error is encountered that is not immediately fatal. This causes the task to retry its readings/whatever else failed M\+A\+X\+\_\+\+E\+R\+R\+O\+R\+\_\+\+C\+O\+U\+NT times, then fail and send error event. T\+O\+DO\+: ensure this is max 500 ms to meet rules for cell reading times. 

\begin{DoxyReturn}{Returns}
true if error\+Counter is below or equal to max error count, false otherwise 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a7b0e95f68b412d5d5e9620ffbae8750d}\label{batteries_8c_a7b0e95f68b412d5d5e9620ffbae8750d}} 
\index{batteries.c@{batteries.c}!calculateStateOfCharge@{calculateStateOfCharge}}
\index{calculateStateOfCharge@{calculateStateOfCharge}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{calculateStateOfCharge()}{calculateStateOfCharge()}}
{\footnotesize\ttfamily float calculate\+State\+Of\+Charge (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Calculates the state of charge of the battery pack. This is a measure of how much capacity the pack has left on its current charge. Currently its implemented as a simple ratio of min cell voltage versus safe limits. 

\begin{DoxyReturn}{Returns}
State of Charge (percent) 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a6b2f1ad817d75d1c5c590814371b5062}\label{batteries_8c_a6b2f1ad817d75d1c5c590814371b5062}} 
\index{batteries.c@{batteries.c}!calculateStateOfPower@{calculateStateOfPower}}
\index{calculateStateOfPower@{calculateStateOfPower}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{calculateStateOfPower()}{calculateStateOfPower()}}
{\footnotesize\ttfamily float calculate\+State\+Of\+Power (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Calculates the state of power of the battery pack. T\+O\+DO\+: this calculation is from 2017, so should be updated for the 2020 pack. 

\begin{DoxyReturn}{Returns}
The state of power of the battery pack (in Watts?) 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a445bbbf2332f3c63a4bfcddf4b78ff43}\label{batteries_8c_a445bbbf2332f3c63a4bfcddf4b78ff43}} 
\index{batteries.c@{batteries.c}!canSendCellTask@{canSendCellTask}}
\index{canSendCellTask@{canSendCellTask}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{canSendCellTask()}{canSendCellTask()}}
{\footnotesize\ttfamily void can\+Send\+Cell\+Task (\begin{DoxyParamCaption}\item[{void $\ast$}]{pv\+Parameters }\end{DoxyParamCaption})}



Sends the cell voltages and temperatures over C\+AN. 

\mbox{\Hypertarget{batteries_8c_a7090234402b08bb512cf5db06702c9f0}\label{batteries_8c_a7090234402b08bb512cf5db06702c9f0}} 
\index{batteries.c@{batteries.c}!checkCellVoltagesAndTemps@{checkCellVoltagesAndTemps}}
\index{checkCellVoltagesAndTemps@{checkCellVoltagesAndTemps}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{checkCellVoltagesAndTemps()}{checkCellVoltagesAndTemps()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def check\+Cell\+Voltages\+And\+Temps (\begin{DoxyParamCaption}\item[{float $\ast$}]{max\+Voltage,  }\item[{float $\ast$}]{min\+Voltage,  }\item[{float $\ast$}]{max\+Temp,  }\item[{float $\ast$}]{min\+Temp,  }\item[{float $\ast$}]{pack\+Voltage }\end{DoxyParamCaption})}



Checks cell voltages and temperatures to ensure they are within safe limits, as well as sending out warnings when the values get close to their limits and updating max/min voltages/temps and calculated pack voltage NB\+: This skips checking temperatures of cells specified as having faulty measurements in \mbox{\hyperlink{batteries_8c_a4bb357024aa0bb23dcfba57009d3f836}{is\+Temp\+Cell\+Working}} array. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ out}}  & {\em max\+Voltage} & The cell voltage of the cell with the max voltage \\
\hline
\mbox{\texttt{ out}}  & {\em min\+Voltage} & The cell voltage of the cell with the min voltage \\
\hline
\mbox{\texttt{ out}}  & {\em max\+Temp} & The cell temperature of the cell with the max temperature \\
\hline
\mbox{\texttt{ out}}  & {\em min\+Temp} & The cell temperature of the cell with the min temperature \\
\hline
\mbox{\texttt{ out}}  & {\em pack\+Voltage} & The sum of all the cell voltages, which should be the output voltage of the pack\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a19d5fb02c3547746d76a121bf9f10807}\label{batteries_8c_a19d5fb02c3547746d76a121bf9f10807}} 
\index{batteries.c@{batteries.c}!cliSetIBus@{cliSetIBus}}
\index{cliSetIBus@{cliSetIBus}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{cliSetIBus()}{cliSetIBus()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def cli\+Set\+I\+Bus (\begin{DoxyParamCaption}\item[{float}]{I\+Bus }\end{DoxyParamCaption})}



For nucleo testing, allows setting a dummy value for the I\+Bus reading. 


\begin{DoxyParams}{Parameters}
{\em I\+Bus} & The value to set for I\+Bus, in volts\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a6e1bc0d2209bd309c4db0a06009a339a}\label{batteries_8c_a6e1bc0d2209bd309c4db0a06009a339a}} 
\index{batteries.c@{batteries.c}!cliSetVBatt@{cliSetVBatt}}
\index{cliSetVBatt@{cliSetVBatt}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{cliSetVBatt()}{cliSetVBatt()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def cli\+Set\+V\+Batt (\begin{DoxyParamCaption}\item[{float}]{V\+Batt }\end{DoxyParamCaption})}



For nucleo testing, allows setting a dummy value for the V\+Batt reading. 


\begin{DoxyParams}{Parameters}
{\em V\+Batt} & The value to set for V\+Batt, in volts\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a2ab7e555695e672e38894f394a31a3ef}\label{batteries_8c_a2ab7e555695e672e38894f394a31a3ef}} 
\index{batteries.c@{batteries.c}!cliSetVBus@{cliSetVBus}}
\index{cliSetVBus@{cliSetVBus}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{cliSetVBus()}{cliSetVBus()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def cli\+Set\+V\+Bus (\begin{DoxyParamCaption}\item[{float}]{V\+Bus }\end{DoxyParamCaption})}



For nucleo testing, allows setting a dummy value for the V\+Bus reading. 


\begin{DoxyParams}{Parameters}
{\em V\+Bus} & The value to set for V\+Bus, in volts\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a533907b25f7b1dbb355151d336ed9ff6}\label{batteries_8c_a533907b25f7b1dbb355151d336ed9ff6}} 
\index{batteries.c@{batteries.c}!continueCharging@{continueCharging}}
\index{continueCharging@{continueCharging}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{continueCharging()}{continueCharging()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def continue\+Charging (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Sends messages to the charger. The charger expects a message every second so this needs to be repeatedly called during charging. 

\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_ae1d79ed043eedc99cbc01f7c59ce369e}\label{batteries_8c_ae1d79ed043eedc99cbc01f7c59ce369e}} 
\index{batteries.c@{batteries.c}!filterCellVoltages@{filterCellVoltages}}
\index{filterCellVoltages@{filterCellVoltages}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{filterCellVoltages()}{filterCellVoltages()}}
{\footnotesize\ttfamily void filter\+Cell\+Voltages (\begin{DoxyParamCaption}\item[{float $\ast$}]{cell\+Voltages,  }\item[{float $\ast$}]{cell\+Voltages\+Filtered }\end{DoxyParamCaption})}



This takes an array of the instantaneous cell volages, and filters them on an ongoing basis using the cell\+Voltages\+Filtered array. For check cell voltages, a filtered version of cell voltages is needed to eliminate noise due to bad contact with A\+MS boards. The hypothesis is that the pogo pins make bad contact with the ams boards when the motors spin, thus the need for filtering. This hasn\textquotesingle{}t been proven however, but the filtering fixed the errors we saw before (info up to date as of May 2020) NB\+: Filter voltages shouldn\textquotesingle{}t be sent over C\+AN, only used with error checking. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em cell\+Voltages} & unfiltered cell voltage readings \\
\hline
\mbox{\texttt{ out}}  & {\em cell\+Voltages\+Filtered} & filtered cell voltage readings \\
\hline
\end{DoxyParams}
\mbox{\Hypertarget{batteries_8c_a1300d8fea84c20d3945380460f61f81d}\label{batteries_8c_a1300d8fea84c20d3945380460f61f81d}} 
\index{batteries.c@{batteries.c}!filterIBus@{filterIBus}}
\index{filterIBus@{filterIBus}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{filterIBus()}{filterIBus()}}
{\footnotesize\ttfamily float filter\+I\+Bus (\begin{DoxyParamCaption}\item[{float}]{I\+Bus }\end{DoxyParamCaption})}



Low pass filters the HV Bus current measurement. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em I\+Bus} & the measured HV Bus current \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The filtered HV Bus current 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a0ee7fbdeb8e2e8413b4fc77ba59223d5}\label{batteries_8c_a0ee7fbdeb8e2e8413b4fc77ba59223d5}} 
\index{batteries.c@{batteries.c}!getIBus@{getIBus}}
\index{getIBus@{getIBus}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{getIBus()}{getIBus()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def get\+I\+Bus (\begin{DoxyParamCaption}\item[{float $\ast$}]{I\+Bus }\end{DoxyParamCaption})}



Get the most recent bus current reading. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ out}}  & {\em I\+Bus} & pointer to a float to store the I\+Bus reading, in amps\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_ab07aef73f633627b5a1a78e40f15961f}\label{batteries_8c_ab07aef73f633627b5a1a78e40f15961f}} 
\index{batteries.c@{batteries.c}!getPackVoltage@{getPackVoltage}}
\index{getPackVoltage@{getPackVoltage}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{getPackVoltage()}{getPackVoltage()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def get\+Pack\+Voltage (\begin{DoxyParamCaption}\item[{float $\ast$}]{pack\+Voltage }\end{DoxyParamCaption})}



Gets the current pack voltage. This returns the pack voltage as calculated by summing all the cell voltages. 


\begin{DoxyParams}{Parameters}
{\em pack\+Voltage} & pointer to a float to return the pack voltage (in volts)\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+De 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a3d41850a2fe8400978c4f68163d726be}\label{batteries_8c_a3d41850a2fe8400978c4f68163d726be}} 
\index{batteries.c@{batteries.c}!getSOCFromVoltage@{getSOCFromVoltage}}
\index{getSOCFromVoltage@{getSOCFromVoltage}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{getSOCFromVoltage()}{getSOCFromVoltage()}}
{\footnotesize\ttfamily float get\+S\+O\+C\+From\+Voltage (\begin{DoxyParamCaption}\item[{float}]{cell\+Voltage }\end{DoxyParamCaption})}



Calculates the SoC of a cell from the cell\textquotesingle{}s voltage. 


\begin{DoxyParams}{Parameters}
{\em cell\+Voltage} & The cell voltage\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
the SoC of the cell in percent (0-\/100) 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_aff30116cb629c2efdad61c2ccaec0c36}\label{batteries_8c_aff30116cb629c2efdad61c2ccaec0c36}} 
\index{batteries.c@{batteries.c}!getVBatt@{getVBatt}}
\index{getVBatt@{getVBatt}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{getVBatt()}{getVBatt()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def get\+V\+Batt (\begin{DoxyParamCaption}\item[{float $\ast$}]{V\+Batt }\end{DoxyParamCaption})}



Get the most recent battery voltage reading (from the HV A\+DC). Note\+: this is only equal to the battery voltage when both contactors are closed. to get the battery voltage in all times, use \mbox{\hyperlink{batteries_8c_ab07aef73f633627b5a1a78e40f15961f}{get\+Pack\+Voltage}}. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ out}}  & {\em pointer} & to a float to store the V\+Batt reading, in volts\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a6fbf3bf910348af26a580fc418f89f5e}\label{batteries_8c_a6fbf3bf910348af26a580fc418f89f5e}} 
\index{batteries.c@{batteries.c}!getVBus@{getVBus}}
\index{getVBus@{getVBus}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{getVBus()}{getVBus()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def get\+V\+Bus (\begin{DoxyParamCaption}\item[{float $\ast$}]{V\+Bus }\end{DoxyParamCaption})}



Get the most recent HV Bus voltage reading (from the HV A\+DC) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ out}}  & {\em pointer} & to a float to store the V\+Bus reading, in volts\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a1ef8191389452a8f21cb2d02b20cba29}\label{batteries_8c_a1ef8191389452a8f21cb2d02b20cba29}} 
\index{batteries.c@{batteries.c}!HVMeasureTask@{HVMeasureTask}}
\index{HVMeasureTask@{HVMeasureTask}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{HVMeasureTask()}{HVMeasureTask()}}
{\footnotesize\ttfamily void H\+V\+Measure\+Task (\begin{DoxyParamCaption}\item[{void $\ast$}]{pv\+Paramaters }\end{DoxyParamCaption})}

Measures the voltage and current on the HV Bus as well as the HV battery pack voltage. Note that the HV battery pack voltage (V\+Batt) is only equal to the actual pack voltage in ceraint contactor states, see precharge\+Discharge procedure on confluence for more info. Instead, use \mbox{\hyperlink{batteries_8c_ab07aef73f633627b5a1a78e40f15961f}{get\+Pack\+Voltage}} which bases it measurement on the sum of cell voltages \mbox{\Hypertarget{batteries_8c_a92932081ca58208175ca6c4e0971f06d}\label{batteries_8c_a92932081ca58208175ca6c4e0971f06d}} 
\index{batteries.c@{batteries.c}!initPackVoltageQueue@{initPackVoltageQueue}}
\index{initPackVoltageQueue@{initPackVoltageQueue}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{initPackVoltageQueue()}{initPackVoltageQueue()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def init\+Pack\+Voltage\+Queue (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Creates the pack voltage queue. Needs to be called before R\+T\+OS starts. 

\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_aed5d06c4a55e40673204ceacf2fde819}\label{batteries_8c_aed5d06c4a55e40673204ceacf2fde819}} 
\index{batteries.c@{batteries.c}!map\_range\_float@{map\_range\_float}}
\index{map\_range\_float@{map\_range\_float}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{map\_range\_float()}{map\_range\_float()}}
{\footnotesize\ttfamily float map\+\_\+range\+\_\+float (\begin{DoxyParamCaption}\item[{float}]{in,  }\item[{float}]{low,  }\item[{float}]{high,  }\item[{float}]{low\+\_\+out,  }\item[{float}]{high\+\_\+out }\end{DoxyParamCaption})}



Maps a value from one range to another in a linear manner. 


\begin{DoxyParams}{Parameters}
{\em in} & The value to map \\
\hline
{\em low} & low value of in range \\
\hline
{\em high} & high value of in range \\
\hline
{\em low\+\_\+out} & low value of out range \\
\hline
{\em high\+\_\+out} & high value of out range\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
in value mapped to out range 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_aa04706789e98d82797970064b10dd0c9}\label{batteries_8c_aa04706789e98d82797970064b10dd0c9}} 
\index{batteries.c@{batteries.c}!pauseBalance@{pauseBalance}}
\index{pauseBalance@{pauseBalance}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{pauseBalance()}{pauseBalance()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def pause\+Balance (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Stops all cells balancing, but stores which cells were balancing to allowing resuming of balance for cells that were balancing. 

\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a37d4140213dc1708776032fc935e0b39}\label{batteries_8c_a37d4140213dc1708776032fc935e0b39}} 
\index{batteries.c@{batteries.c}!publishBusVoltagesAndCurrent@{publishBusVoltagesAndCurrent}}
\index{publishBusVoltagesAndCurrent@{publishBusVoltagesAndCurrent}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{publishBusVoltagesAndCurrent()}{publishBusVoltagesAndCurrent()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def publish\+Bus\+Voltages\+And\+Current (\begin{DoxyParamCaption}\item[{float $\ast$}]{p\+I\+Bus,  }\item[{float $\ast$}]{p\+V\+Bus,  }\item[{float $\ast$}]{p\+V\+Batt }\end{DoxyParamCaption})}



Publishes the most recent HV Bus measurements to queues for other tasks to read from Queue overwrite, Queue peek, and queue size of 1 is used to ensure only the most recent data is in the queue and read from the queue. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em p\+Ibus} & pointer to the HV bus current measurement (in Amps) \\
\hline
\mbox{\texttt{ in}}  & {\em p\+Vbus} & pointer to the HV bus voltage measurement (in Volts) \\
\hline
\mbox{\texttt{ in}}  & {\em p\+Vbatt} & pointer to the HV battery voltage measurement (in Volts) \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_afa698a16023626be583ce5082c76f5ec}\label{batteries_8c_afa698a16023626be583ce5082c76f5ec}} 
\index{batteries.c@{batteries.c}!publishPackVoltage@{publishPackVoltage}}
\index{publishPackVoltage@{publishPackVoltage}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{publishPackVoltage()}{publishPackVoltage()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def publish\+Pack\+Voltage (\begin{DoxyParamCaption}\item[{float}]{pack\+Voltage }\end{DoxyParamCaption})}



Publishes the current pack voltage value to the queue for other tasks to read from. 


\begin{DoxyParams}{Parameters}
{\em pack\+Voltage} & The current pack voltage in volts\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a4d72951e5a03e396bb864b5c45bda0f0}\label{batteries_8c_a4d72951e5a03e396bb864b5c45bda0f0}} 
\index{batteries.c@{batteries.c}!readBusVoltagesAndCurrents@{readBusVoltagesAndCurrents}}
\index{readBusVoltagesAndCurrents@{readBusVoltagesAndCurrents}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{readBusVoltagesAndCurrents()}{readBusVoltagesAndCurrents()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def read\+Bus\+Voltages\+And\+Currents (\begin{DoxyParamCaption}\item[{float $\ast$}]{I\+Bus,  }\item[{float $\ast$}]{V\+Bus,  }\item[{float $\ast$}]{V\+Batt }\end{DoxyParamCaption})}



Measures HV voltages and currents using the HV A\+DC. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ out}}  & {\em Ibus} & pointer to the HV bus current measurement (in Amps) \\
\hline
\mbox{\texttt{ out}}  & {\em Vbus} & pointer to the HV bus voltage measurement (in Volts) \\
\hline
\mbox{\texttt{ out}}  & {\em Vbatt} & pointer to the HV battery voltage measurement (in Volts)\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a36a3c81e474331b59839cb2f565c7704}\label{batteries_8c_a36a3c81e474331b59839cb2f565c7704}} 
\index{batteries.c@{batteries.c}!readCellVoltagesAndTemps@{readCellVoltagesAndTemps}}
\index{readCellVoltagesAndTemps@{readCellVoltagesAndTemps}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{readCellVoltagesAndTemps()}{readCellVoltagesAndTemps()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def read\+Cell\+Voltages\+And\+Temps (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Reads the cell voltages and temperatures from the A\+MS boards. The battery temperature and cell voltages are stored in the global arrays which are also used for sending them over C\+AN. 

\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a82969943d42e6067b966c64c61196dcd}\label{batteries_8c_a82969943d42e6067b966c64c61196dcd}} 
\index{batteries.c@{batteries.c}!resumeBalance@{resumeBalance}}
\index{resumeBalance@{resumeBalance}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{resumeBalance()}{resumeBalance()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def resume\+Balance (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Resumes balancing after call to \mbox{\hyperlink{batteries_8c_aa04706789e98d82797970064b10dd0c9}{pause\+Balance}}. 

\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_aacf3b5ff9648b813208cb6f91b370fef}\label{batteries_8c_aacf3b5ff9648b813208cb6f91b370fef}} 
\index{batteries.c@{batteries.c}!setMaxChargeCurrent@{setMaxChargeCurrent}}
\index{setMaxChargeCurrent@{setMaxChargeCurrent}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{setMaxChargeCurrent()}{setMaxChargeCurrent()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def set\+Max\+Charge\+Current (\begin{DoxyParamCaption}\item[{float}]{max\+Current }\end{DoxyParamCaption})}



Sets the maximum current for the charger. 


\begin{DoxyParams}{Parameters}
{\em max\+Current} & The maximum current, in Amps\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_acd55a62448b408952283c28d12dd4c1d}\label{batteries_8c_acd55a62448b408952283c28d12dd4c1d}} 
\index{batteries.c@{batteries.c}!setSendOnlyOneCell@{setSendOnlyOneCell}}
\index{setSendOnlyOneCell@{setSendOnlyOneCell}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{setSendOnlyOneCell()}{setSendOnlyOneCell()}}
{\footnotesize\ttfamily void set\+Send\+Only\+One\+Cell (\begin{DoxyParamCaption}\item[{int}]{cell\+Idx }\end{DoxyParamCaption})}



Repeatedly send the cell voltage and temperature for a specific cell. This is instead of the normal behaviour which cycles through all the cells sending a message every \mbox{\hyperlink{batteries_8c_ab75dbcd7e0a59fc3d1fc3715de87544a}{C\+A\+N\+\_\+\+C\+E\+L\+L\+\_\+\+S\+E\+N\+D\+\_\+\+P\+E\+R\+I\+O\+D\+\_\+\+MS}}. Useful for battery testing to monitor a cell at higher frequency. 


\begin{DoxyParams}{Parameters}
{\em cell\+Idx} & The cell to repeatedly send (note, this uses firmwares 0 based indexing, instead of electricals 1 based indexing of cell numbers) \\
\hline
\end{DoxyParams}
\mbox{\Hypertarget{batteries_8c_a43ea41cc1c21bd36b3622076e20b596c}\label{batteries_8c_a43ea41cc1c21bd36b3622076e20b596c}} 
\index{batteries.c@{batteries.c}!startCharging@{startCharging}}
\index{startCharging@{startCharging}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{startCharging()}{startCharging()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def start\+Charging (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Sends the maximum charge current and voltage to the charger and waits for the charger to start charging. 

\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_ad54912c48ac30fc66796b2aeca58cea7}\label{batteries_8c_ad54912c48ac30fc66796b2aeca58cea7}} 
\index{batteries.c@{batteries.c}!stopBalance@{stopBalance}}
\index{stopBalance@{stopBalance}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{stopBalance()}{stopBalance()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def stop\+Balance (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Stops all cells balancing by sending command to A\+MS boards. 

\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}
\mbox{\Hypertarget{batteries_8c_a5cf6c235603af078c2dc841ae579f3b5}\label{batteries_8c_a5cf6c235603af078c2dc841ae579f3b5}} 
\index{batteries.c@{batteries.c}!stopCharging@{stopCharging}}
\index{stopCharging@{stopCharging}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{stopCharging()}{stopCharging()}}
{\footnotesize\ttfamily H\+A\+L\+\_\+\+Status\+Type\+Def stop\+Charging (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Sends a command to the charger to stop charging. 

\begin{DoxyReturn}{Returns}
H\+A\+L\+\_\+\+Status\+Type\+Def 
\end{DoxyReturn}


\doxysubsection{Variable Documentation}
\mbox{\Hypertarget{batteries_8c_a4bb357024aa0bb23dcfba57009d3f836}\label{batteries_8c_a4bb357024aa0bb23dcfba57009d3f836}} 
\index{batteries.c@{batteries.c}!isTempCellWorking@{isTempCellWorking}}
\index{isTempCellWorking@{isTempCellWorking}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{isTempCellWorking}{isTempCellWorking}}
{\footnotesize\ttfamily bool is\+Temp\+Cell\+Working\mbox{[}T\+E\+M\+P\+C\+E\+L\+L\+\_\+\+C\+O\+U\+NT\mbox{]}}

{\bfseries Initial value\+:}
\begin{DoxyCode}{0}
\DoxyCodeLine{= \{}
\DoxyCodeLine{}
\DoxyCodeLine{}
\DoxyCodeLine{true , true , true , \textcolor{keyword}{false}, true , true , true , true , true , true , \textcolor{keyword}{false}, \textcolor{keyword}{false},}
\DoxyCodeLine{}
\DoxyCodeLine{true , true , true , \textcolor{keyword}{false}, true , true , true , true , true , true , \textcolor{keyword}{false}, \textcolor{keyword}{false},}
\DoxyCodeLine{}
\DoxyCodeLine{true , true , \textcolor{keyword}{false}, \textcolor{keyword}{false}, true , \textcolor{keyword}{false}, \textcolor{keyword}{false}, true , true , \textcolor{keyword}{false}, true , true ,}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false},}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{false}, true , true , \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, true , true , true , \textcolor{keyword}{false}, \textcolor{keyword}{false},}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false}, \textcolor{keyword}{false},}
\DoxyCodeLine{\}}

\end{DoxyCode}
Since some thermistors don\textquotesingle{}t give accurate readings (as of June 2020 not sure why, but maybe due to bad mechanical connections) this array specifies which temperature readings are working. The working readings are the only ones checked to ensure they are within safe limits and to determine min and max temperatures. \mbox{\Hypertarget{batteries_8c_a1e19984c8df58b545da1c8f8b5547acd}\label{batteries_8c_a1e19984c8df58b545da1c8f8b5547acd}} 
\index{batteries.c@{batteries.c}!maxChargeVoltage@{maxChargeVoltage}}
\index{maxChargeVoltage@{maxChargeVoltage}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{maxChargeVoltage}{maxChargeVoltage}}
{\footnotesize\ttfamily float max\+Charge\+Voltage = L\+I\+M\+I\+T\+\_\+\+O\+V\+E\+R\+V\+O\+L\+T\+A\+GE $\ast$ V\+O\+L\+T\+A\+G\+E\+C\+E\+L\+L\+\_\+\+C\+O\+U\+NT}

Charging voltage limit to be sent to charger. Charging is actually stopped based on min cell SoC as specified by \mbox{\hyperlink{batteries_8c_a1c3f97f617827a946894da14b7e6e4d4}{C\+H\+A\+R\+G\+E\+\_\+\+S\+T\+O\+P\+\_\+\+S\+OC}} \mbox{\Hypertarget{batteries_8c_ab483cabe57068f7e0fd4bcaee6c1fb59}\label{batteries_8c_ab483cabe57068f7e0fd4bcaee6c1fb59}} 
\index{batteries.c@{batteries.c}!voltageToSOCLookup@{voltageToSOCLookup}}
\index{voltageToSOCLookup@{voltageToSOCLookup}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{voltageToSOCLookup}{voltageToSOCLookup}}
{\footnotesize\ttfamily float voltage\+To\+S\+O\+C\+Lookup\mbox{[}N\+U\+M\+\_\+\+S\+O\+C\+\_\+\+L\+O\+O\+K\+U\+P\+\_\+\+V\+A\+LS\mbox{]}}

{\bfseries Initial value\+:}
\begin{DoxyCode}{0}
\DoxyCodeLine{= \{}
\DoxyCodeLine{   0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20,}
\DoxyCodeLine{   21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40,}
\DoxyCodeLine{   41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60,}
\DoxyCodeLine{   61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80,}
\DoxyCodeLine{   81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100}
\DoxyCodeLine{\}}

\end{DoxyCode}
Lookup table to convert cell voltage to cell state of charge. See B\+MU confluence page for more info \mbox{\Hypertarget{batteries_8c_a61bd11f0a0377192a9a1950e18664728}\label{batteries_8c_a61bd11f0a0377192a9a1950e18664728}} 
\index{batteries.c@{batteries.c}!warningSentForCellTemp@{warningSentForCellTemp}}
\index{warningSentForCellTemp@{warningSentForCellTemp}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{warningSentForCellTemp}{warningSentForCellTemp}}
{\footnotesize\ttfamily bool warning\+Sent\+For\+Cell\+Temp\mbox{[}T\+E\+M\+P\+C\+E\+L\+L\+\_\+\+C\+O\+U\+NT\mbox{]}}

Set to true if we\textquotesingle{}ve already sent a high temperature warning for this cell to stop repeated warnings being sent. Reset to false on init or when cell voltage increases above high temperature warning limit \mbox{\Hypertarget{batteries_8c_afeb7e3ce5be75e8a7d03ae9bbc3c2150}\label{batteries_8c_afeb7e3ce5be75e8a7d03ae9bbc3c2150}} 
\index{batteries.c@{batteries.c}!warningSentForCellVoltage@{warningSentForCellVoltage}}
\index{warningSentForCellVoltage@{warningSentForCellVoltage}!batteries.c@{batteries.c}}
\doxysubsubsection{\texorpdfstring{warningSentForCellVoltage}{warningSentForCellVoltage}}
{\footnotesize\ttfamily bool warning\+Sent\+For\+Cell\+Voltage\mbox{[}V\+O\+L\+T\+A\+G\+E\+C\+E\+L\+L\+\_\+\+C\+O\+U\+NT\mbox{]}}

Set to true if we\textquotesingle{}ve already sent a low voltage warning for this cell to stop repeated warnings being sent. Reset to false on init or when cell voltage increases above low voltage warning limit 