#ifndef PRECHARGEDISCHARGE_H

#define PRECHARGEDISCHARGE_H

#include "main.h"
#include "freertos.h"
#include "bsp.h"

typedef enum PCDC_Notifications_t {
    PRECHARGE_NOTIFICATION,
    DISCHARGE_NOTIFICATION,
    STOP_NOTIFICATION,
} PCDC_Notifications_t;

/*
 * Discharge constants
 */

#define DISCHARGE_MEASURE_PERIOD_MS 100
#define DISCHARGE_DONE_BUS_VOLTAGE (0.2F)

#define ZERO_CURRENT_MAX_AMPS (0.01)
#define CONTACTOR_OPEN_ZERO_CURRENT_TIMEOUT_MS 50

/*
 * Precharge constants
 */

#define PRECHARGE_RESISTOR_OHMS (10000)

// Timeouts
#define PRECHARGE_STEP_1_WAIT_TIME_MS 2000

#define PRECHARGE_STEP_2_WAIT_TIME_MS 2000
#define PRECHARGE_STEP_2_TIMEOUT 5000

#define PRECHARGE_STEP_3_WAIT_TIME_MS 2000

#define PRECHARGE_STEP_4_CURRENT_MEASURE_PERIOD_MS (5)
#define PRECHARGE_STEP_4_TIMEOUT 20000

#define PRECHARGE_STEP_5_CURRENT_MEASURE_PERIOD_MS (1)
#define PRECHARGE_STEP_5_TIMEOUT 1000

// Constants

#define VPACK (20.0F)
#define PACK_VOLTAGE_TOLERANCE_PERCENT (0.05)

#define PRECHARGE_STEP_1_VBUS_MAX_PERCENT_VPACK (0.02F)
#define PRECHARGE_STEP_1_VBATT_MIN_PERCENT_VPACK (0.3F)
#define PRECHARGE_STEP_1_VBATT_MAX_PERCENT_VPACK (0.8F)
#define PRECHARGE_STEP_1_CURRENT_MAX (0.100F)

#define PRECHARGE_STEP_2_VBUS_MAX_PERCENT_VPACK (0.02F)
#define PRECHARGE_STEP_2_PERCENT_VBATT_MIN (0.95)
#define PRECHARGE_STEP_2_CURRENT_MAX (0.100F)

#define PRECHARGE_STEP_3_VBUS_MAX_PERCENT_VPACK (0.02F)
#define PRECHARGE_STEP_3_VBATT_MIN_PERCENT_VPACK (0.3F)
#define PRECHARGE_STEP_3_VBATT_MAX_PERCENT_VPACK (0.8F)
#define PRECHARGE_STEP_3_CURRENT_MAX (0.100F)

#define PRECHARGE_STEP_4_COMPLETE_PERCENT_VPACK (0.95F)
#define MIN_PRECHARGE_PERCENT_IDEAL_CURRENT (0.6F)

#define PRECHARGE_STEP_5_COMPLETE_PERCENT_VPACK (0.98F)
#define PRECHARGE_STEP_5_PERCENT_IDEAL_CURRENT_REQUIRED (0.8F)

/* only used for testing in cli */
HAL_StatusTypeDef getIBus(float *IBus);
HAL_StatusTypeDef getVBatt(float *VBatt);
HAL_StatusTypeDef getVBus(float * VBus);

#endif /* end of include guard: PRECHARGEDISCHARGE_H */
