# Automatically checkout `develop` or `master` in common-all when we are
# working in with those branches in the project repo. I'm doing this because
# the common-all pointer is not always remembered to be updated, so this will
# help keep things in sync
#
# Author: Desmond Good
# Date:   Feb 4 2021

RED="\033[0;31m"
NC="\033[0m" # No colour

# Check if common-all really is a git submodule since it's not guaranteed.
# Exit with instruction to initialize if not.
if [ -f ./common-all/.git ]; then
    CA_BRANCH="$(git -C ./common-all/ symbolic-ref --short -q HEAD)"
    if [ $? -ne 0 ]; then
        CA_BRANCH="(detached HEAD)"
    fi
    echo "post-checkout hook: common-all branch = ${CA_BRANCH}"
else
    echo "${RED}post-checkout hook: Warning! common-all is not initialized as a submodule${NC}"
    echo "Initialize it with the following commands:"
    echo "   git submodule init"
    echo "   git submodule update"
    exit 0
fi

# If we are checking out `develop`/`master`... checkout `develop`/`master`
# in common-all
PROJECT_BRANCH="$(git symbolic-ref --short -q HEAD)"
if [ "$PROJECT_BRANCH" = "develop" ] || [ "$PROJECT_BRANCH" = "master" ]; then
    if [ "$CA_BRANCH" != "$PROJECT_BRANCH" ]; then
        echo "post-checkout hook: Automatically checking out ${PROJECT_BRANCH} in common-all (previously ${CA_BRANCH})"
        git -C ./common-all/ checkout $PROJECT_BRANCH 
        git -C ./common-all/ fetch && git -C ./common-all/ pull
    fi
fi

